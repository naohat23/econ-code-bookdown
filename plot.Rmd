# ggplot2によるグラフ作成

第5章「ggplot2によるグラフ作成」では、`tidyverse`の`ggplot2`パッケージを主に使用したグラフ作成方法について解説します。

## 第5章の準備

### パッケージのインポート

```{r, results='hide', warning=FALSE, message=FALSE, paged.print=FALSE}
library(esquisse)
library(geofacet)
library(ggplotgui)
library(ggpubr)
library(ggsci)
library(ggrepel)
library(lemon)
library(magrittr)
library(openxlsx)
library(RColorBrewer)
library(readxl)
library(tidyverse)
```

### 外部データセットの取得

この章では、外部データセットとして以下のデータを使用します。第2章のコードを使用してあらかじめウェブからデータセットを取得してください。

-   OWIDのCOVID-19データセット：　`data_owid`
-   日本の県内総生産：　`data_gdp_pref`
-   日本の四半期別GDP：　`data_gdp_jp`

## ggplot2とは

`ggplot2`パッケージでは、最初に`ggplot()`関数でグラフを作成するデータと変数を指定します。その後に、`geom_histogram()`などのグラフの種類を指定する関数や、`scale_x_date`などの軸設定の関数、`theme()`などの各種設定の関数を`+`演算子で追加していきます。

`ggplot()`関数では、まず`data`引数に`tibble`形式の縦型データを指定します。次に`mapping`引数に`aes()`関数を指定し、`aes()`関数の中でX軸やY軸の変数、必要に応じて`color`や`size`など変数の値に応じて変化させる色・サイズなどの要素を指定します。

なお、グラフの種類により、X軸、Y軸に指定できる変数の型（連続型、離散型）が決まっていますので、注意してください。

`ggplot2`パッケージの詳細については[公式ウェブサイト](https://ggplot2.tidyverse.org/)を参照してください。各関数の使い方については、公式ウェブサイトのチートシートが分かりやすくまとまっています。

## ggplot2の設定

第2章で紹介した`ggplot2`の設定です。筆者の実行環境はMacのため、Windowsの設定はコメントアウトしています。

```{r, paged.print=FALSE}
# Windowsのグラフ設定（筆者の実行環境では不要のためコメントアウト）
# windowsFonts("MEIRYO" = windowsFont("Meiryo UI"))
# windowsFonts("YUGO" = windowsFont("Yu Gothic UI"))
# theme_set(theme_light(base_family = "YUGO"))

# Macのグラフ設定
theme_set(theme_light(base_family = "HiraKakuProN-W3"))
```

## GUI形式の直感的なグラフ作成

この章では`ggplot2`パッケージによるグラフ作成方法を紹介しますが、`ggplot2`はコードを記述してグラフを作成するため、試行錯誤を伴う探索的データ分析（EDA）にはあまり向いていません。

そこで、`ggplot2`によるグラフ作成を行う前に、GUI形式でコードを記述せずにグラフを作成できるパッケージを用い、どのようなグラフを作成するべきか検討します。

### esquisseパッケージ

`esquisse`パッケージは、ドラッグ＆ドロップでX軸・Y軸の変数や色・サイズを変化させる属性の変数を指定し、グラフを作成することができる便利なパッケージです。ただし、データセットの規模が大きいと起動に時間がかかるため、変数の数が多い場合は、あらかじめ注目する変数を絞るといった前処理が必要です。

Rで下記のコードを実行すると別のウィンドウで`esquisse`の画面が立ち上がり、GUI形式でインタラクティブにグラフを作成することができます。ウェブサイト上では実行できないため、各自で試してみてください。

```{r, eval=FALSE, paged.print=FALSE}
# irisデータ
esquisse::esquisser(data = iris)
```

```{r, eval=FALSE, paged.print=FALSE}
## 世界の新型コロナデータの一部を抽出
data_owid %>% 
  dplyr::select(location, date, new_cases_smoothed) %>% 
  dplyr::filter(location %in% c("Japan", "United States", "United Kingdom", "Germany", "France", "Italy")) %>% 
  esquisse::esquisser()
```

### ggplotguiパッケージ

その他、GUI形式でグラフを作成することができるパッケージとして、`ggplotgui`があります。同様にウェブサイト上では実行できないため、各自で試してみてください。

```{r, eval=FALSE, paged.print=FALSE}
# irisデータ
ggplotgui::ggplot_shiny(data = iris)
```

```{r, eval=FALSE, paged.print=FALSE}
## 世界の新型コロナデータの一部を抽出
data_owid %>% 
  dplyr::select(location, date, new_cases_smoothed) %>% 
  dplyr::filter(location %in% c("Japan", "United States", "United Kingdom", "Germany", "France", "Italy")) %>% 
  ggplotgui::ggplot_shiny()
```

## 1次元の度数分布（離散型）

-   X軸：離散型変数
-   Y軸：なし

離散型変数の1次元の度数分布を作成するには、度数棒グラフを用います。度数棒グラフを作成するには`geom_bar()`関数を使用します。

### 度数棒グラフの基本形

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = manufacturer)
       ) + 
  geom_bar(alpha = 1.0, # 塗りつぶしの透明度
           color = "darkblue", # 線の色
           fill = "lightblue", # 塗りつぶしの色
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           )
```

## 1次元の度数分布（連続型）

-   X軸：連続型変数
-   Y軸：なし

連続型変数の1次元の度数分布を作成するには、ヒストグラムを用います。ヒストグラムを作成するには`geom_histogram()`関数や`geom_freqpoly()`関数を使用します。

### ヒストグラムの基本形

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy)
       ) +
  geom_histogram(binwidth = 5, # 階級幅
                 color = "gray", # 線の色
                 fill = "darkblue", # 塗りつぶしの色
                 size = 0.5 # 線の太さ
                 )
```

### 横並びヒストグラム

グループ別のヒストグラムを横並び形式で作成するには、`position`引数に`"dodge"`を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy, fill = class)
       ) +
  geom_histogram(binwidth = 5, # 階級幅
                 position = "dodge", # 横並びポジション
                 color = "black", # 線の色
                 size = 0.5 # 線の太さ
                 )
```

グループ別の度数分布は`geom_freqpoly()`関数でも可視化することができます。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy, color = class)
       ) +
  geom_freqpoly(binwidth = 5, # 階級幅
                size = 0.5 # 線の太さ
                )
```

### 積上ヒストグラム

グループ別のヒストグラムを積上形式で作成するには、`position`引数に`"stack"`を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy, fill = class)
       ) +
  geom_histogram(binwidth = 5, # 階級幅
                 position = "stack", # 積上ポジション
                 color = "black", # 線の色
                 size = 0.5 # 線の太さ
                 )
```

## 1次元の密度グラフ

-   X軸：連続型変数
-   Y軸：なし

密度グラフは`geom_density()`関数で作成します。

### 密度グラフの基本形

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy)
       ) +
  geom_density(kernel = "gaussian", # カーネル関数の種類
               color = "darkblue", # 線の色
               linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
               size = 1.0 # 線の太さ
               )
```

### 横並び密度グラフ

グループ別の密度グラフを横並び形式で作成するには、`position`引数に`"dodge"`を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy, color = class)
       ) +
  geom_density(kernel = "gaussian", # カーネル関数の種類
               position = "dodge", # 横並びポジション
               linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
               size = 1.0 # 線の太さ
               )
```

横並びの密度グラフは`geom_freqpoly()`関数でも作成できます。`geom_freqpoly()`関数で`mapping = aes(y = ..density..)`を指定すると、各グループの度数を標準化して密度グラフに変換します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy, y = ..density.., color = class)
       ) +
  geom_freqpoly(binwidth = 5, # 階級幅
                size = 0.5 # 線の太さ
                )
```

### 積上密度グラフ

グループ別の密度グラフを積上形式で作成するには、`position`引数に`"stack"`を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = hwy, fill = class)
       ) +
  geom_density(kernel = "gaussian", # カーネル関数の種類
               position = "stack", # 積上ポジション
               color = "black", # 線の色
               linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
               size = 0.5 # 線の太さ
               )
```

## 2次元の度数分布（離散型）

-   X軸：離散型変数
-   Y軸：離散型変数

離散型変数の2次元の度数分布を作成するには、度数バブルチャートや度数ヒートマップを用います。度数バブルチャートを作成するには`geom_count()`関数を使用します。また、離散型変数の度数ヒートマップを作成するには`geom_tile()`関数を使用します。

### 度数バブルチャートの基本形

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = manufacturer, y = class)
       ) +
  geom_count(alpha = 0.5, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             stroke = 0.5 # 線の太さ
             ) + 
  scale_size_area(max_size = 15 # 変量とマーカーの面積を比例させる
                  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1.0))
```

### 度数ヒートマップの基本形

```{r, paged.print=FALSE}
ggplot(data = mpg %>% 
         dplyr::count(manufacturer, class), # データの度数を格納した変数を作成
       mapping = aes(x = manufacturer, y = class, fill = n)
       ) +
  geom_tile(height = 1.0, # タイルの高さ
            width = 1.0, # タイルの幅
            alpha = 1.0, # 塗りつぶしの色の透明度
            color = "grey", # 線の色
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 0.5 # 線の太さ
            ) +
  scale_fill_viridis_c() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1.0))
```

## 2次元の度数分布（連続型）

-   X軸：連続型変数
-   Y軸：連続型変数

連続型変数の2次元の度数分布を作成するには、度数ヒートマップを用います。連続型変数の度数ヒートマップを作成するには`geom_bin2d()`関数を使用します。

### 度数ヒートマップの基本形

```{r, paged.print=FALSE}
ggplot(data = diamonds,
       mapping = aes(x = carat, y = price)
       ) +
  geom_bin2d(bins = c(100, 75), # X軸・Y軸の階級数（デフォルトは30）
             alpha = 1.0, # 塗りつぶしの色の透明度
             color = NA, # 線の色
             linetype = "solid", # 線の種類
             size = 0.2 # 線の太さ
             ) +
  scale_fill_viridis_c()
```

## 2次元の密度グラフ

-   X軸：連続型変数
-   Y軸：連続型変数

2次元の密度グラフを作成するには、`geom_density2d()`関数ファミリーを使用します。

まず、使用するサンプルデータを作成します。データサイズが大きい場合、2次元密度グラフを作成するために時間を要するため、`dplyr::sample_n()`関数でサンプリングします。

```{r, paged.print=FALSE}
diamonds_small <- diamonds %>% 
  dplyr::sample_n(size = 5000)
```

### 2次元密度グラフの基本形

```{r, paged.print=FALSE}
ggplot(data = diamonds_small,
       mapping = aes(x = carat, y = price)
       ) + 
  geom_density2d()
```

### 2次元密度グラフの塗りつぶし版

```{r, paged.print=FALSE}
ggplot(data = diamonds_small,
       mapping = aes(x = carat, y = price)
       ) + 
  geom_density2d_filled() +
  scale_fill_brewer(palette = "Reds",
                    direction = 1
                    )
```

## QQプロット

-   X軸・Y軸：連続型変数

QQプロットは`geom_qq()`関数で作成します。他のグラフと異なり、`mapping = aes(sample = 変数)`で変数を指定します。

QQ（Quantile-Quantile）プロットは、データが正規分布にどの程度近いかを検証するグラフです。Y軸にデータを順番に並べた値、X軸にデータが正規分布に従うと仮定した場合にとりうる期待値を標準化した値をとり、散布図を描いたものです。

QQプロットが直線上にある場合、データは正規分布に従うと解釈できます。一方、QQプロットが直線から乖離している場合は、正規分布に従っておらず、分布にゆがみがあると解釈できます。

例えば、QQプロットが[右下に凸な形状の場合は、データは右に長い裾（テール）]{.underline}をもちます。一方、QQプロットが[左上に凸な形状の場合は、データの分布は左に長い裾（テール）]{.underline}をもちます。

また、QQプロットが[S字状（前半は右下に凸、後半は左上に凸）の場合は、データの両裾が重い、いわゆるファット・テールの分布]{.underline}になります。一方、[逆S字状（前半は左上に凸、後半は右下に凸）の場合は、ピーク部分が突出した分布]{.underline}になります。

```{r, paged.print=FALSE}
# 右に長い裾をもつデータのQQプロット
ggplot(data = iris,
       mapping = aes(sample = Sepal.Length)
       ) +
  geom_qq_line() +
  geom_qq()
```

```{r, paged.print=FALSE}
# ファット・テールをもつデータのQQプロット
ggplot(data = economics,
       mapping = aes(sample = unemploy)
       ) +
  geom_qq_line() +
  geom_qq()
```

## 散布図・バブルチャート

-   X軸：連続型変数
-   Y軸：連続型変数

散布図とバブルチャートは`geom_point()`関数で作成します。バブルチャートの上に`geom_smooth()`関数で近似曲線を重ねることができます。

まず、プロット用のデータを作成します。

```{r, paged.print=FALSE}
data_mpg_point <- mpg %>% 
  dplyr::group_by(manufacturer) %>% 
  dplyr::summarise(across(c(displ, cty, hwy), mean, na.rm = TRUE))

data_mpg_point
```

### 散布図の基本形

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             size = 2.0, # マーカーの大きさ
             stroke = 0.5 # 線の太さ
             )
```

### バブルチャートの基本形

バブルチャートを作成するには、`ggplot()`関数の`mapping = aes()`関数で`size`引数にバブルのサイズを変化させたい変数を指定します。

```{r, paged.print=FALSE}
ggplot(data = data_mpg_point,
       mapping = aes(x = cty, y = hwy, size = displ) # aes() 関数内のsize引数に連続型変数を指定
       ) +
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             stroke = 0.5 # 線の太さ
             )
```

### 散布図にコネクタ線を追加

散布図のマーカー間をつなぐコネクタ線を追加するには、`geom_path()`関数を追加します。折れ線グラフを作成する`geom_line()`関数とは異なるので注意してください。

`geom_path()`関数と`geom_line()`関数はどちらもマーカー間をつなぐコネクタ線を追加する関数ですが、`geom_path()`関数はデータセット上の順番で線を引く一方、`geom_line()`関数はデータセット上の順番に関わらずX軸上の順番で線を引くという違いがあります。

```{r, paged.print=FALSE}
economics %>% 
  dplyr::filter(date >= "2000-01-01") %>% 
  ggplot(mapping = aes(x = unemploy, y = uempmed)) +
  geom_path(alpha = 1.0, # 塗りつぶしの透明度
            color = "darkblue", # 線の色
            size = 0.5 # 線の大きさ
            ) +
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             size = 2.0, # マーカーの大きさ
             stroke = 0.5 # 線の太さ
             )
```

### 散布図に近似曲線を追加

散布図に近似曲線を追加するには、`geom_smooth()`関数を使用します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             size = 2.0, # マーカーの大きさ
             stroke = 0.5 # 線の太さ
             ) +
  geom_smooth(formula = y ~ x, # 近似曲線の推計式
              method = "loess", # 近似手法 (lm, glm, gam, loess)
              alpha = 0.5, # 誤差範囲の透明度
              color = "black", # 近似曲線の色
              fill = "gray", # 誤差範囲の色
              linetype = "dashed", # 近似曲線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
              size = 1.0 # 近似曲線の太さ
              )
```

### 散布図にラベルを追加

散布図にラベルを追加するには、`ggrepel`パッケージの`geom_text_repel()`関数を使用します。`geom_text_repel()`関数は、散布図のマーカーとラベルが重ならないようにラベルの位置を自動で調整します。

```{r, paged.print=FALSE}
ggplot(data = data_mpg_point,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             size = 2.0, # マーカーの大きさ
             stroke = 0.5 # 線の太さ
             ) +
  geom_text_repel(mapping = aes(label = manufacturer),
                  seed = NA, # テキストの配置を決定するランダムシード
                  direction = "both", # テキストの整列方向 (both / x / y)
                  hjust = 0.0, # 横方向の整列位置 (0-1) 
                  vjust = 0.5, # 縦方向の整列位置 (0-1)
                  nudge_x = NULL, # マーカーからの横方向のスペース (NULL, 0-)
                  nudge_y = NULL, # マーカーからの縦方向のスペース (NULL, 0-)
                  box.padding = 0.5, # テキスト周囲のスペース (0-)
                  point.padding = 0.1, # マーカー周囲のスペース (0-)
                  segment.alpha = 1.0, # 引き出し線の透明度
                  segment.color = "grey", # 引き出し線の色
                  segment.size = 0.5, # 引き出し線の太さ
                  min.segment.length = 0, # 引き出し線の最低長
                  color = "black", # テキストの色
                  fontface = "plain", # テキストの書体 (plain / bold / italic / bold.italic)
                  size = 4.0 # テキストのサイズ
                  )
```

### バブルチャートにラベルを追加

```{r, paged.print=FALSE}
ggplot(data = data_mpg_point,
       mapping = aes(x = cty, y = hwy, size = displ) # aes() 関数内のsize引数に連続型変数を指定
       ) +
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             stroke = 0.5 # 線の太さ
             ) +
  geom_text_repel(mapping = aes(label = manufacturer),
                  seed = NA, # テキストの配置を決定するランダムシード
                  direction = "both", # テキストの整列方向 (both / x / y)
                  hjust = 0.0, # 横方向の整列位置 (0-1) 
                  vjust = 0.5, # 縦方向の整列位置 (0-1)
                  nudge_x = NULL, # マーカーからの横方向のスペース (NULL, 0-)
                  nudge_y = NULL, # マーカーからの縦方向のスペース (NULL, 0-)
                  box.padding = 1.0, # テキスト周囲のスペース (0-)
                  point.padding = 0.1, # マーカー周囲のスペース (0-)
                  segment.alpha = 1.0, # 引き出し線の透明度
                  segment.color = "grey", # 引き出し線の色
                  segment.size = 0.5, # 引き出し線の太さ
                  min.segment.length = 0, # 引き出し線の最低長
                  color = "black", # テキストの色
                  fontface = "plain", # テキストの書体 (plain / bold / italic / bold.italic)
                  size = 4.0 # テキストのサイズ
                  ) +
  scale_size_area(max_size = 15 # 変量とマーカーの面積を比例させる
                  )
```

## 棒グラフ

-   X軸：離散型変数
-   Y軸：連続型変数

棒グラフは`geom_col()`関数で作成します。

まず、プロット用のデータを作成します。

```{r, paged.print=FALSE}
data_mpg_col <- mpg %>% 
  dplyr::group_by(manufacturer) %>% 
  dplyr::summarise(across(c(cty, hwy), mean, na.rm = TRUE))

data_mpg_col
```

```{r, warning=FALSE, message=FALSE, paged.print=FALSE}
data_owid_col <- data_owid %>% 
  dplyr::select(location, date, new_cases) %>% 
  dplyr::filter(location %in% c("Japan", "United Kingdom", "Germany", "France", "Italy")) %>% 
  dplyr::mutate(year = str_c(lubridate::year(date), "年"), .after = "date") %>% 
  dplyr::group_by(location, year) %>% 
  dplyr::summarise(across(new_cases, sum, na.rm = TRUE))

data_owid_col
```

### 縦棒グラフの基本形

```{r, paged.print=FALSE}
ggplot(data = data_mpg_col,
       mapping = aes(x = manufacturer, y = cty)
       ) + 
  geom_col(alpha = 1.0, # 塗りつぶしの透明度
           color = "darkblue", # 線の色
           fill = "lightblue", # 塗りつぶしの色
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1.0))
```

### 横棒グラフ

横棒グラフを作成するには、縦棒グラフを作成した後に`coord_flip()`関数で横棒グラフに転換します。そのため、X軸とY軸の変数指定は縦棒グラフの場合と同じです。

```{r, paged.print=FALSE}
ggplot(data = data_mpg_col,
       mapping = aes(x = manufacturer, y = cty)
       ) + 
  geom_col(alpha = 1.0, # 塗りつぶしの透明度
           color = "darkblue", # 線の色
           fill = "lightblue", # 塗りつぶしの色
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  coord_flip()
```

### 縦棒グラフの順序並べ替え

縦棒グラフのX軸の順番を並べ替えるには、X軸の変数を指定する際に`fct_reorder()`関数を使用します。

```{r, paged.print=FALSE}
ggplot(data = data_mpg_col,
       mapping = aes(x = fct_reorder(manufacturer, -cty), y = cty)
       ) + 
  geom_col(alpha = 1.0, # 塗りつぶしの透明度
           color = "darkblue", # 線の色
           fill = "lightblue", # 塗りつぶしの色
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1.0))
```

### 縦棒グラフにラベルを追加

縦棒グラフにデータラベルを追加するには、`geom_text()`関数を使用します。

```{r, paged.print=FALSE}
ggplot(data = data_mpg_col,
       mapping = aes(x = fct_reorder(manufacturer, -cty), y = cty)
       ) + 
  geom_col(alpha = 1.0, # 塗りつぶしの透明度
           color = "darkblue", # 線の色
           fill = "lightblue", # 塗りつぶしの色
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  geom_text(mapping = aes(label = cty %>% sprintf(fmt = "%0.1f")), # sprintf() 関数で数値の表示形式を指定
            vjust = -1, # 縦方向の整列位置 (0-1)
            color = "black", # テキストの色
            fontface = "plain", # テキストの書体 (plain / bold / italic / bold.italic)
            size = 4.0 # テキストのサイズ
            ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1.0))
```

### 横並び縦棒グラフ

複数の縦棒グラフを横並び形式で作成するには、`position`引数に`position_dodge2()`関数や`position_dodge()`関数を指定します。

`position_dodge2()`関数を指定すると、縦棒の間が適度に離れたグラフが作成されます。縦棒の間隔を`padding`引数で指定します。

```{r, paged.print=FALSE}
ggplot(data = data_owid_col,
       mapping = aes(x = location, y = new_cases, fill = year, group = rev(year))
       ) + 
  geom_col(position = position_dodge2(padding = 0.1), # 横並びポジション
           alpha = 1.0, # 塗りつぶしの透明度
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           )
```

`position_dodge()`関数を指定すると、縦棒が重なったグラフが作成されます。縦棒の重なり度合いを`width`引数で指定します。

```{r, paged.print=FALSE}
ggplot(data = data_owid_col,
       mapping = aes(x = location, y = new_cases, fill = year, group = rev(year))
       ) + 
  geom_col(position = position_dodge(width = 0.5), # 横並びポジション
           alpha = 1.0, # 塗りつぶしの透明度
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           )
```

### 積上縦棒グラフ

複数の縦棒グラフを積上形式で作成するには、`position`引数に`position_stack()`関数を指定します。

```{r, paged.print=FALSE}
ggplot(data = data_owid_col,
       mapping = aes(x = location, y = new_cases, fill = year, group = rev(year))
       ) + 
  geom_col(position = position_stack(), # 積上ポジション
           alpha = 1.0, # 塗りつぶしの透明度
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  guides(fill = guide_legend(reverse = TRUE))
```

### 積上縦棒グラフにラベルを追加

```{r, paged.print=FALSE}
ggplot(data = data_owid_col,
       mapping = aes(x = location, y = new_cases, fill = year, group = rev(year))
       ) + 
  geom_col(position = position_stack(), # 積上ポジション
           alpha = 1.0, # 塗りつぶしの透明度
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  geom_text(mapping = aes(label = new_cases %>% sprintf(fmt = "%0.1f")), # sprintf() 関数で数値の表示形式を指定
            position = position_stack(vjust = 0.5), # position_stack() 関数で積上棒グラフ上のラベル位置を指定
            color = "white", # テキストの色
            fontface = "plain", # テキストの書体 (plain / bold / italic / bold.italic)
            size = 4.0 # テキストのサイズ
            ) +
  guides(fill = guide_legend(reverse = TRUE))
```

### 100％積上縦棒グラフ

複数の縦棒グラフを合計が100％になる積上形式で作成するには、`position`引数に`position_fill()`関数を指定します。

```{r, paged.print=FALSE}
ggplot(data = data_owid_col,
       mapping = aes(x = location, y = new_cases, fill = year, group = rev(year))
       ) + 
  geom_col(position = position_fill(), # 割合積上ポジション
           alpha = 1.0, # 塗りつぶしの透明度
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  guides(fill = guide_legend(reverse = TRUE))
```

### 100％積上縦棒グラフにラベルを追加

```{r, paged.print=FALSE}
data_owid_col %>% 
  dplyr::group_by(location) %>% 
  dplyr::mutate(percent = new_cases / sum(new_cases)) %>% 
  ggplot(mapping = aes(x = location, y = new_cases, fill = year, group = rev(year))) + 
  geom_col(position = position_fill(), # 割合ポジション
           alpha = 1.0, # 塗りつぶしの透明度
           size = 0.5, # 線の太さ
           width = 0.9 # 棒の幅 (0-1)
           ) +
  geom_text(mapping = aes(label = percent %>% sprintf(fmt = "%0.2f")), # sprintf() 関数で数値の表示形式を指定
            position = position_fill(vjust = 0.5), # position_fill() 関数で割合棒グラフ上のラベル位置を指定
            color = "white", # テキストの色
            fontface = "plain", # テキストの書体 (plain / bold / italic / bold.italic)
            size = 4.0 # テキストのサイズ
            ) +
  guides(fill = guide_legend(reverse = TRUE))
```

## 円グラフ

-   X軸：単一の値
-   Y軸：連続型変数

円グラフを作成するには、`geom_col()`関数で積上棒グラフを作成した後に、`coord_polar()`関数で円グラフに転換します。

まず、プロット用のデータを作成します。

```{r, paged.print=FALSE}
data_mpg_circle <- mpg %>% 
  dplyr::group_by(class) %>% 
  dplyr::summarise(across(c(hwy), mean, na.rm = TRUE))

data_mpg_circle
```

### 円グラフの基本形

```{r, paged.print=FALSE}
ggplot(data = data_mpg_circle,
       mapping = aes(x = 1, y = hwy, fill = class, group = rev(class))
       ) + 
  geom_col(position = position_stack(), # 積上ポジション
           alpha = 1.0, # 塗りつぶしの透明度
           color = "grey", # 線の色
           size = 0.5 # 線の太さ
           ) +
  geom_text(mapping = aes(label = hwy %>% sprintf(fmt = "%0.1f")), # sprintf() 関数で数値の表示形式を指定
            position = position_stack(vjust = 0.5), # position_stack() 関数で積上棒グラフ上のラベル位置を指定
            color = "white", # テキストの色
            fontface = "plain", # テキストの書体 (plain / bold / italic / bold.italic)
            size = 4.0 # テキストのサイズ
            ) +
  coord_polar(theta = "y", # 円グラフを作成する軸
              start = 0, # 円グラフの開始位置（ラジアン）
              direction = 1 # 円グラフの方向（1：時計回り、-1：反時計回り）
              ) +
  theme(panel.grid = element_blank(), # パネルの軸や目盛り線を表示しない
        axis.title = element_blank(),
        axis.text  = element_blank(),
        axis.ticks = element_blank()
        ) +
  guides(fill = guide_legend(reverse = FALSE))
```

## 折れ線グラフ

-   X軸：日付型変数
-   Y軸：連続型変数

折れ線グラフは時系列データを可視化する最も基本的なグラフで、`geom_line()`関数で作成します。

まず、プロット用のデータを作成します。

```{r, paged.print=FALSE}
data_owid_line <- data_owid %>%
  dplyr::select(location, date, new_cases_smoothed) %>% 
  dplyr::filter(location %in% c("Japan", "United Kingdom", "Germany", "France", "Italy"),
                date >= "2022-01-01",
                date <= "2022-12-31"
                ) %>% 
  tidyr::drop_na(everything())

data_owid_line
```

### 折れ線グラフの基本形

```{r, paged.print=FALSE}
ggplot(data = economics,
       mapping = aes(x = date, y = unemploy)
       ) +
  geom_line(alpha = 1.0, # 線の透明度
            color = "darkblue", # 線の色
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            )
```

### 折れ線グラフにマーカーを追加

折れ線グラフを作成する`geom_line()`関数と、散布図を作成する`geom_point()`関数を併用します。

```{r, paged.print=FALSE}
ggplot(data = economics,
       mapping = aes(x = date, y = unemploy)
       ) +
  geom_line(alpha = 1.0, # 線の透明度
            color = "darkblue", # 線の色
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            ) +
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             size = 2.0, # マーカーの大きさ
             stroke = 0.5 # 線の太さ
             )
```

### 折れ線グラフに系列ラベルを追加

折れ線グラフの数が多く凡例が分かりにくい場合などに、折れ線グラフの右側に系列名のラベルを追加します。ラベルを追加するには、`ggrepel`パッケージの`geom_text_repel`関数を使用します。

```{r, paged.print=FALSE}
ggplot(data = data_owid_line,
       mapping = aes(x = date, y = new_cases_smoothed, color = location)
       ) +
  geom_line(alpha = 1.0, # 線の透明度
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            ) +
  geom_text_repel(data = data_owid_line %>%
                    dplyr::group_by(location) %>% 
                    dplyr::filter(date == max(date)),
                  mapping = aes(x = date, y = new_cases_smoothed, label = location),
                  seed = NA, # テキストの配置を決定するランダムシード
                  direction = "y", # テキストの整列方向 (both / x / y)
                  hjust = 0.0, # 横方向の整列位置 (0-1) 
                  vjust = 0.5, # 縦方向の整列位置 (0-1)
                  nudge_x = 5, # マーカーからの横方向のスペース (NULL, 0-)
                  nudge_y = NULL, # マーカーからの縦方向のスペース (NULL, 0-)
                  box.padding = 0.1, # テキスト周囲のスペース (0-)
                  point.padding = 0.1, # マーカー周囲のスペース (0-)
                  segment.alpha = 1.0, # 引き出し線の透明度
                  segment.color = "grey", # 引き出し線の色
                  segment.size = 0.5, # 引き出し線の太さ
                  min.segment.length = Inf, # 引き出し線の最低長
                  fontface = "plain", # テキストの書体 (plain / bold / italic / bold.italic)
                  size = 3.0 # テキストのサイズ
                  ) +
  # 軸
  coord_cartesian(xlim = as.Date(c("2022-01-01", "2023-03-31")), # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  ylim = c(0, max(data_owid_line$new_cases_smoothed) * 1.05), # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  expand = FALSE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_x_date(breaks = breaks_x <- seq(as.Date("1900-01-01"), as.Date("2099-12-31"), by = "3 months"), # 日付目盛ベクトル
               date_labels = str_c(str_sub(lubridate::year(breaks_x), 1, 4), "/", lubridate::month(breaks_x)), # 日付目盛ベクトルをラベル用に加工
               ) +
  theme(legend.position = "none")
```

## ステップグラフ

-   X軸：日付型変数
-   Y軸：連続型変数

ステップグラフは折れ線グラフの特殊形です。政策金利のように、段階的に値が変化するデータに適しています。ステップグラフは`geom_step()`関数で作成します。

まず、サンプルデータを作成します。ここでは、Our World in Dataの`data_owid`データセットに含まれるStringency Indexのステップグラフを作成します。Stringency Indexは、各国当局が実施する新型コロナウイルス感染対策の厳格度を示す指数であり、段階的に値が変化します。

```{r, paged.print=FALSE}
data_owid_step <- data_owid %>% 
  dplyr::select(location, date, stringency_index) %>% 
  dplyr::filter(location %in% c("Japan", "United Kingdom", "Germany", "France", "Italy"))

data_owid_step
```

### ステップグラフの基本形

```{r, paged.print=FALSE}
ggplot(data = data_owid_step,
       mapping = aes(x = date, y = stringency_index, color = location)
       ) +
  geom_step(alpha = 1.0, # 線の透明度
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            )
```

## 面グラフ

-   X軸：日付型変数
-   Y軸：連続型変数

面グラフは折れ線グラフの特殊形です。面グラフには2種類あり、折れ線グラフとX軸で挟まれた範囲を塗りつぶすグラフは`geom_area()`関数、2つの折れ線グラフで挟まれた範囲を塗りつぶすグラフは`geom_ribbon()`関数で作成します。後者は特にリボングラフと呼ばれ、信頼区間の可視化に用いることができます。

まず、プロット用のデータを作成します。

```{r, paged.print=FALSE}
data_owid_line <- data_owid %>%
  dplyr::select(location, date, new_cases_smoothed) %>% 
  dplyr::filter(location %in% c("Japan", "United Kingdom", "Germany", "France", "Italy"),
                date >= "2022-01-01"
                ) %>% 
  tidyr::drop_na(everything())

data_owid_line
```

### 面グラフの基本形

```{r, paged.print=FALSE}
ggplot(data = economics,
       mapping = aes(x = date, y = unemploy)
       ) +
  geom_area(alpha = 1.0, # 線の透明度
            color = "darkblue", # 線の色
            fill = "lightblue", # 塗りつぶしの色
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            )
```

### 積上面グラフ

複数の面グラフを積上形式で作成するには、`position`引数に`position_stack()`関数を指定します。

```{r, paged.print=FALSE}
data_owid_line %>% 
  dplyr::mutate(location = factor(location,
                                  levels = c("Japan", "United Kingdom", "Germany", "France", "Italy") %>% rev()
                                  )
                ) %>% 
  ggplot(mapping = aes(x = date, y = new_cases_smoothed, fill = location)) +
  geom_area(position = position_stack(),
            alpha = 1.0, # 線の透明度
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            )
```

### リボングラフの基本形

リボングラフでは、`aes()`関数の中で塗りつぶし範囲の下端を`ymin`引数、上端を`ymax`引数に指定します。

```{r, paged.print=FALSE}
data_owid_line %>% 
  dplyr::group_by(date) %>% 
  dplyr::summarise(new_cases_max = max(new_cases_smoothed, na.rm = TRUE),
                   new_cases_min = min(new_cases_smoothed, na.rm = TRUE)
                   ) %>% 
  ggplot(mapping = aes(x = date, ymin = new_cases_min, ymax = new_cases_max)) +
  geom_ribbon(alpha = 1.0, # 線の透明度
              color = "darkblue", # 線の色
              fill = "lightblue", # 塗りつぶしの色
              linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
              size = 0.5 # 線の太さ
              )
```

### リボングラフに折れ線グラフを追加

リボングラフに折れ線グラフを追加する際は、まず`geom_ribbon()`関数でリボングラフを作成し、そのあとに`+`演算子で`geom_line()`関数をつなげて折れ線グラフを追加します。

```{r, paged.print=FALSE}
data_owid_line %>% 
  dplyr::group_by(date) %>% 
  dplyr::summarise(new_cases_max = max(new_cases_smoothed, na.rm = TRUE),
                   new_cases_median = median(new_cases_smoothed, na.rm = TRUE),
                   new_cases_min = min(new_cases_smoothed, na.rm = TRUE)
                   ) %>% 
  ggplot(mapping = aes(x = date, ymin = new_cases_min, ymax = new_cases_max, y = new_cases_median)) +
  geom_ribbon(alpha = 1.0, # 線の透明度
              color = "darkblue", # 線の色
              fill = "lightblue", # 塗りつぶしの色
              linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
              size = 0.5 # 線の太さ
              ) +
  geom_line(alpha = 1.0, # 線の透明度
            color = "red", # 線の色
            linetype = "dashed", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            )
```

## 箱ひげ図・ヴァイオリングラフ

-   X軸：離散型変数
-   Y軸：連続型変数

データの分布範囲を可視化するには箱ひげ図やヴァイオリングラフを用います。箱ひげ図は`geom_boxplot()`関数、ヴァイオリングラフは`geom_violin()`関数で作成します。

また、`geom_jitter()`関数で作成するジッターグラフを併用し、箱ひげ図やヴァイオリングラフに個別データの位置をプロットすると、データの分布がより具体的に分かりやすくなります。

### 箱ひげ図の基本形

箱ひげ図は一般的に、ひげの下端が最小値、箱の下端が第1四分位数、箱内部の横線が中央値、箱の上端が第3四分位数、ひげの上端が最大値を表します。

しかし、`ggplot2`パッケージの`geom_boxplot()`で作成すると、ひげの下端・上端は箱の下端・上端から1.5×IQRの範囲内にある最小・最大のサンプルの位置を表すことに注意が必要です。その範囲外にあるサンプルは外れ値として扱われます。なお、IQRは四分位範囲（第3四分位数-第1四分位数）を意味します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = class, y = hwy)
       ) +
  geom_boxplot(outlier.alpha = 1.0, # 外れ値マーカーの塗りつぶしの透明度
               outlier.color = "darkblue", # 外れ値マーカーの線の色
               outlier.fill = "lightblue", # 外れ値マーカーの塗りつぶしの色
               outlier.shape = 21, # 外れ値マーカーの種類（外れ値を表示しない場合はNA）
               outlier.size = 2.0, # 外れ値マーカーの大きさ
               outlier.stroke = 0.5, # 外れ値マーカーの線の太さ
               alpha = 0.5, # 箱の塗りつぶしの透明度
               color = "darkblue", # 箱ひげの線の色
               fill = "lightblue", # 箱の塗りつぶしの色
               size = 0.5 # 箱ひげの線の太さ
               )
```

### 箱ひげ図に個別サンプルを追加

箱ひげ図にジッターグラフで個別サンプルを追加する場合は、データの重複表示を避けるため、`geom_boxplot()`関数の`outlier.shape`引数に`NA`を指定して、箱ひげ図による外れ値のマーカーを非表示にします。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = class, y = hwy)
       ) +
  geom_boxplot(outlier.shape = NA, # 外れ値マーカーの種類（外れ値を表示しない場合はNA）
               alpha = 0.5, # 箱の塗りつぶしの透明度
               color = "darkblue", # 箱ひげの線の色
               fill = "lightblue", # 箱の塗りつぶしの色
               size = 0.5 # 箱ひげの線の太さ
               ) +
  geom_jitter(height = 0.3, # マーカーの縦方向の分布範囲
              width = 0.3, # マーカーの横方向の分布範囲
              alpha = 1.0, # マーカーの塗りつぶしの透明度
              color = "darkblue", # マーカーの線の色
              fill = "darkblue", # マーカーの塗りつぶしの色
              shape = 21, # マーカーの種類
              size = 1.0, # マーカーの大きさ
              stroke = 0.5 # マーカーの線の太さ
              )
```

### 横並び箱ひげ図

`aes()`関数内の`color`引数や`fill`引数に属性を表す変数を指定すると、横並び形式の箱ひげ図を作成することができます。

ここでは、`mpg`データセットにおいて自動車モデル年数のデータを格納している`year`変数を`fill`引数に指定しています。属性には離散型変数を指定しますが、`year`変数は数値型（連続型変数）のため、事前に`factor()`関数で因子型（離散型変数）に変換しています。

なお、塗りつぶしの色は`fill`引数に指定した`year`変数の値に基づいて自動的に決まるため、`geom_boxplot()`関数内で塗りつぶしの色を決める`outlier.fill`引数と`fill`引数は削除しておきます。

```{r, paged.print=FALSE}
ggplot(data = mpg %>% 
         dplyr::mutate(year = factor(year)),
         mapping = aes(x = class, y = hwy, fill = year)
       ) +
  geom_boxplot(outlier.alpha = 1.0, # 外れ値マーカーの塗りつぶしの透明度
               outlier.color = "black", # 外れ値マーカーの線の色
               outlier.shape = 21, # 外れ値マーカーの種類（外れ値を表示しない場合はNA）
               outlier.size = 2.0, # 外れ値マーカーの大きさ
               outlier.stroke = 0.5, # 外れ値マーカーの線の太さ
               alpha = 0.5, # 箱の塗りつぶしの透明度
               color = "black", # 箱ひげの線の色
               size = 0.5 # 箱ひげの線の太さ
               )
```

横並び箱ひげ図にジッターグラフで個別サンプルを追加する場合は、`geom_jitter()`関数の`height`引数と`width`引数を削除し、`position`引数に`position_jitterdodge()`関数を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg %>% 
         dplyr::mutate(year = factor(year)),
         mapping = aes(x = class, y = hwy, fill = year)
       ) +
  geom_boxplot(outlier.shape = NA, # 外れ値マーカーの種類（外れ値を表示しない場合はNA）
               alpha = 0.5, # 箱の塗りつぶしの透明度
               color = "black", # 箱ひげの線の色
               size = 0.5 # 箱ひげの線の太さ
               ) +
  geom_jitter(alpha = 1.0, # マーカーの塗りつぶしの透明度
              color = "black", # マーカーの線の色
              shape = 21, # マーカーの種類
              size = 1.0, # マーカーの大きさ
              stroke = 0.5, # マーカーの線の太さ
              position = position_jitterdodge()
              )
```

### ヴァイオリングラフの基本形

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = class, y = hwy)
       ) +
  geom_violin(scale = "area", # ヴァイオリンの大きさ（area：すべての面積が同じ、count：サンプル個数に比例、width：すべての幅が同じ）
              alpha = 0.5, # ヴァイオリンの塗りつぶしの透明度
              color = "darkblue", # ヴァイオリンの線の色
              fill = "lightblue", # ヴァイオリンの塗りつぶしの色
              linetype = "solid", # ヴァイオリンの線の種類
              size = 0.5 # ヴァイオリンの線の太さ
              )
```

### ヴァイオリングラフに個別サンプルを追加

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = class, y = hwy)
       ) +
  geom_violin(scale = "area", # ヴァイオリンの大きさ（area：すべての面積が同じ、count：サンプル個数に比例、width：すべての幅が同じ）
              alpha = 0.5, # ヴァイオリンの塗りつぶしの透明度
              color = "darkblue", # ヴァイオリンの線の色
              fill = "lightblue", # ヴァイオリンの塗りつぶしの色
              linetype = "solid", # ヴァイオリンの線の種類
              size = 0.5 # ヴァイオリンの線の太さ
              ) +
  geom_jitter(height = 0.4, # マーカーの縦方向の分布範囲
              width = 0.4, # マーカーの横方向の分布範囲
              alpha = 1.0, # マーカーの塗りつぶしの透明度
              color = "darkblue", # マーカーの線の色
              fill = "darkblue", # マーカーの塗りつぶしの色
              shape = 21, # マーカーの種類
              size = 1.0, # マーカーの大きさ
              stroke = 0.5 # マーカーの線の太さ
              )
```

## ドットプロット

-   X軸：離散型変数
-   Y軸：離散型変数

ドットプロットは`geom_dotplot()`関数で作成します。実務では、FOMCで示される参加者の政策金利予想を可視化する際に使用されます。

### ドットプロットの基本形

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = class, y = hwy)
       ) +
  geom_dotplot(binaxis = "y",
               binwidth = 0.5,
               stackdir = "center",
               alpha = 1.0, # マーカーの塗りつぶしの透明度
               color = "darkblue", # マーカーの線の色
               fill = "lightblue", # マーカーの塗りつぶしの色
               stroke = 0.5 # マーカーの線の太さ
               )
```

## 複合グラフ（ファセット）

複数のグラフをまとめたファセットを作成するには、`facet`関数ファミリーを使用します。どのようなファセットにするかで使用する関数が異なります。

### 行方向の複合グラフ

行方向に複合グラフを並べる場合は、`facet_rep_grid()`関数の`rows`引数に`vars(離散型変数)`の形でグラフを分けて作成したい変数名を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point() +
  facet_rep_grid(rows = vars(class), # 変数class別にグラフを作成
                 scales = "fixed", # 目盛設定（fixed：全グラフ共通、free：全グラフ独立、free_x：X軸のみ独立、free_y：Y軸のみ独立）
                 repeat.tick.labels = FALSE # 目盛表示（TRUE：すべてのグラフに表示、FALSE：端のグラフのみ表示
                 )
```

### 列方向の複合グラフ

列方向に複合グラフを並べる場合は、`facet_rep_grid()`関数の`cols`引数に`vars(離散型変数)`の形でグラフを分けて作成したい変数名を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point() +
  facet_rep_grid(cols = vars(class), # 変数class別にグラフを作成
                 scales = "fixed", # 目盛設定（fixed：全グラフ共通、free：全グラフ独立、free_x：X軸のみ独立、free_y：Y軸のみ独立）
                 repeat.tick.labels = FALSE # 目盛表示（TRUE：すべてのグラフに表示、FALSE：端のグラフのみ表示
                 )
```

### 行・列方向の複合グラフ

行・列方向に複合グラフを並べる場合は、`facet_rep_grid()`関数の`rows`引数と`cols`引数にそれぞれ`vars(離散型変数)`の形でグラフを分けて作成したい変数名を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point() +
  facet_rep_grid(rows = vars(year), # 変数year別に行方向のグラフを作成
                 cols = vars(class), # 変数class別に列方向のグラフを作成
                 scales = "fixed", # 目盛設定（fixed：全グラフ共通、free：全グラフ独立、free_x：X軸のみ独立、free_y：Y軸のみ独立）
                 repeat.tick.labels = TRUE # 目盛表示（TRUE：すべてのグラフに表示、FALSE：端のグラフのみ表示
                 )
```

### 行数・列数を指定した複合グラフ

行数と列数を指定してグラフを順番に並べるには、`facet_rep_wrap()`関数の`facets`引数に「`~ 離散型変数」`の形でグラフを分けて作成したい変数名を指定し、`nrow`引数と`ncol`引数に行数・列数を指定します。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point() +
  facet_rep_wrap(facets = ~ manufacturer, # 変数manufacturer別にグラフを作成
                 nrow = 3, # 行方向のグラフ数
                 ncol = 5, # 列方向のグラフ数
                 scales = "fixed", # 目盛設定（fixed：全グラフ共通、free：全グラフ独立、free_x：X軸のみ独立、free_y：Y軸のみ独立）
                 repeat.tick.labels = TRUE # 目盛表示（TRUE：すべてのグラフに表示、FALSE：端のグラフのみ表示
                 )
```

### 複合グラフの設定

ファセットの各種設定を行うには、`theme()`関数内に必要事項を記入します。

```{r, paged.print=FALSE}
# 行数・列数を指定した複合グラフの例
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  geom_point() +
  facet_rep_wrap(facets = ~ manufacturer # 変数manufacturer別にグラフを作成
                 ) + 
  theme(strip.background = element_rect(color = NA, # ファセットタイトル領域の枠の色
                                        fill = "White" # ファセットタイトル領域の塗りつぶしの色（NAで無色）
                                        ),
        strip.text = element_text(color = "Black", # ファセットタイトルの色
                                  face = "bold", # ファセットタイトルの書体
                                  size = 8, # ファセットタイトルのフォントサイズ
                                  hjust = 0.5, # ファセットタイトルの横方向の整列位置
                                  vjust = 0.5 # ファセットタイトルの縦方向の整列位置
                                  ),
        panel.spacing.x = unit(x = 2, units = "mm"), # ファセットのグラフ間の横方向のスペース
        panel.spacing.y = unit(x = 2, units = "mm") # ファセットのグラフ間の縦方向のスペース
        )
```

## 地図ファセット

国別・州別・都道府県別のデータを、地図を模した複合グラフに表示するには、`geofacet`パッケージの`facet_geo()`関数を使用します。

ここでは、日本の県内総生産データを使用します。

```{r, paged.print=FALSE}
data_gdp_pref
```

`geofacet`パッケージでは、都道府県名と地図上の位置を結びつける`jp_prefs_grid2`データが用意されています。ただし都道府県名が英語表記でしか格納されていないため、日本語表記を名寄せして追加します。

```{r, paged.print=FALSE}
# geofacetのjp_prefs_grid2に都道府県名の日本語表記を追加
data_prefs <- data_gdp_pref %>% 
  dplyr::select(pref_code, pref_name) %>% 
  dplyr::distinct() %>% 
  dplyr::rename(code = pref_code)

jp_prefs_grid2 %<>%
  dplyr::left_join(data_prefs, by = "code")
```

そのうえで、ファセット部分に`facet_geo()`関数を用いると、都道府県別のデータを日本地図を模した形でグラフ化することができます。

```{r, paged.print=FALSE}
ggplot(data = data_gdp_pref,
       mapping = aes(x = year, y = gdp_nominal_pchg)
       ) +
  geom_line() +
  geom_point() +
  facet_geo(facets = ~ pref_name, # 変数pref_name別にグラフを作成
            grid = "jp_prefs_grid2", # 使用する地図グリッド
            scales = "fixed" # 目盛設定（fixed：全グラフ共通、free：全グラフ独立、free_x：X軸のみ独立、free_y：Y軸のみ独立）
            ) +
  theme(strip.background = element_rect(color = NA, # ファセットタイトル領域の枠の色
                                        fill = NA # ファセットタイトル領域の塗りつぶしの色（NAで無色）
                                        ),
        strip.text = element_text(color = "Black", # ファセットタイトルの色
                                  face = "bold", # ファセットタイトルの書体
                                  size = 8, # ファセットタイトルのフォントサイズ
                                  hjust = 0.5, # ファセットタイトルの横方向の整列位置
                                  vjust = 0.5 # ファセットタイトルの縦方向の整列位置
                                  ),
        panel.spacing.x = unit(x = 1, units = "mm"), # ファセットのグラフ間の横方向のスペース
        panel.spacing.y = unit(x = 0.5, units = "mm") # ファセットのグラフ間の縦方向のスペース
        )
```

## 補助線

水平線、垂直線、傾き・切片のある直線、といった補助線を追加するには、それぞれ`geom_hline()`関数、`geom_vline()`関数、`geom_abline()`関数を使用します。

補助線を追加する際には、グラフをプロットする関数（ここでは散布図の`geom_point()`関数）との順序に注意してください。コード上で先に記述した方がグラフ上では背面に、後に記述した方が前面に配置されます。

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy)
       ) +
  # 水平線（背面）
  geom_hline(yintercept = 20, # 水平線の縦軸との交点
             color = "Tomato", # 水平線の色
             size = 0.5 # 水平線の太さ
             ) +
  # 垂直線（背面）
  geom_vline(xintercept = 20, # 垂直線の横軸との交点
             color = "Forestgreen", # 垂直線の色
             size = 0.5 # 垂直線の太さ
             ) +
  # 傾き・切片のある直線（背面）
  geom_abline(intercept = 5, # 直線の切片
              slope = 1, # 直線の傾き
              color = "gold", # 直線の色
              size = 2.0 # 直線の太さ
              ) +
  # 散布図
  geom_point(alpha = 1.0, # 塗りつぶしの透明度
             color = "darkblue", # 線の色
             fill = "lightblue", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             size = 2.0, # マーカーの大きさ
             stroke = 0.5 # 線の太さ
             ) +
  # 水平線（前面）
  geom_hline(yintercept = 25, # 水平線の縦軸との交点
             color = "Tomato", # 水平線の色
             size = 0.5 # 水平線の太さ
             ) +
  # 垂直線（前面）
  geom_vline(xintercept = 25, # 垂直線の横軸との交点
             color = "Forestgreen", # 垂直線の色
             size = 0.5 # 垂直線の太さ
             ) +
  # 傾き・切片のある直線（前面）
  geom_abline(intercept = 10, # 直線の切片
              slope = 1, # 直線の傾き
              color = "gold", # 直線の色
              size = 2.0 # 直線の太さ
              )
```

## 設定：色

変数の値や属性に応じて色を自動で変化させるには、`geom`関数ファミリーでグラフを作成したあとに、`+`演算子で`scale_color_*()`関数ファミリー（線の色）や`scale_fill_*()`関数ファミリー（塗りつぶしの色）をつなぎます。色の変化に対応する変数が離散型か連続型かによって、どの`scale_color_*()`・`scale_fill_*()`関数を用いるかが変わります。

まず、プロット用のデータを作成します。`x`が離散型変数、`y`が連続型変数です。

```{r, paged.print=FALSE}
data_color <- tibble(x = 1:20 %>% factor(), y = 1:20)

data_color
```

### 離散型：手動指定

自分で色の割り当てを決める方法です。Rで使用できる色の種類については、[こちら](http://www.okadajp.org/RWiki/?%E8%89%B2%E8%A6%8B%E6%9C%AC)を参照してください。

```{r, paged.print=FALSE}
ggplot(data = data_color %>% 
         dplyr::slice(1:5),
       mapping = aes(x = x, y = y, color = x, fill = x)
       ) +
  geom_col() +
  # 色
  scale_color_manual(values = c("Red", "Salmon", "Gold", "Forestgreen", "Darkblue") # colorで指定した変数の離散値と同数の色を指定
                     ) +
  scale_fill_manual(values = c("Red", "Salmon", "Gold", "Forestgreen", "Darkblue") # fillで指定した変数の離散値と同数の色を指定
                    )
```

### 離散型：Brewer

`RColorBrewer`パッケージでは、様々な種類の美麗なプリセットカラーパレットが利用できます。

```{r, paged.print=FALSE}
# カラーパレットの確認
RColorBrewer::display.brewer.all()
```

```{r, paged.print=FALSE}
ggplot(data = data_color %>% 
         dplyr::slice(1:12),
       mapping = aes(x = x, y = y, color = x, fill = x)
       ) +
  geom_col() +
  # 色
  scale_color_brewer(palette = "Paired", # カラーパレット名
                     direction = 1 # 色の順序（-1で逆順）
                     ) +
  scale_fill_brewer(palette = "Paired", # カラーパレット名
                    direction = 1 # 色の順序（-1で逆順）
                    )
```

### 離散型：Viridis

色覚障害に対応したカラーパレットです。パレットの種類などの詳細は[こちら](https://ggplot2.tidyverse.org/reference/scale_viridis.html)を参照してください。

```{r, paged.print=FALSE}
ggplot(data = data_color %>% 
         dplyr::slice(1:10),
       mapping = aes(x = x, y = y, color = x, fill = x)
       ) +
  geom_col() +
  # 色
  scale_color_viridis_d(option = "viridis", # パレットの種類（magma / inferno / plasma / viridis / cividis）
                        direction = 1 # 色の順序（-1で逆順）
                        ) +
  scale_fill_viridis_d(option = "viridis", # パレットの種類（magma / inferno / plasma / viridis / cividis）
                       direction = 1 # 色の順序（-1で逆順）
                       )
```

### 離散型：ggsci

様々な科学ジャーナルで使用されるカラーパレットです。パレットの種類などの詳細は[こちら](https://cran.r-project.org/web/packages/ggsci/vignettes/ggsci.html)をご覧ください。

```{r, paged.print=FALSE}
ggplot(data = data_color %>% 
         dplyr::slice(1:10),
       mapping = aes(x = x, y = y, color = x, fill = x)
       ) +
  geom_col() +
  # 色
  scale_color_npg() + 
  scale_fill_npg()
```

### 連続型：distiller

こちらは、`RColorBrewer`パッケージの連続型変数用の関数です。様々な種類の美麗なプリセットカラーパレットが利用できます。

```{r, paged.print=FALSE}
# カラーパレットの確認
RColorBrewer::display.brewer.all()
```

```{r, warning=FALSE, message=FALSE, paged.print=FALSE}
ggplot(data = data_color,
       mapping = aes(x = x, y = y, fill = y)
       ) +
  geom_col() +
  # 色
  scale_fill_distiller(palette = "Blues", # カラーパレット名
                       direction = 1 # 色の順序（-1で逆順）
                       )
```

### 連続型：Viridis

色覚障害に対応したカラーパレットです。パレットの種類などの詳細は[こちら](https://ggplot2.tidyverse.org/reference/scale_viridis.html)を参照してください。

```{r, warning=FALSE, message=FALSE, paged.print=FALSE}
ggplot(data = data_color,
       mapping = aes(x = x, y = y, fill = y)
       ) +
  geom_col() +
  # 色
  scale_fill_viridis_c(option = "viridis", # パレットの種類（magma / inferno / plasma / viridis / cividis）
                       direction = 1 # 色の順序（-1で逆順）
                       )
```

### 連続型：gradient

自分で色を指定してグラデーションを作成するカラーパレットです。2色グラデーション、3色グラデーション、n色グラデーションの3種類の関数があります。n色グラデーションでは、事前にベースとなるカラーパレットを`RColorBrewer::display.brewer.all()`関数などで確認して使用します。

```{r, warning=FALSE, message=FALSE, paged.print=FALSE}
# 2色グラデーション
ggplot(data = data_color,
       mapping = aes(x = x, y = y, fill = y)
       ) +
  geom_col() +
  # 色
  scale_fill_gradient(low = "Red", # 最小値の色
                      high = "Forestgreen" # 最大値の色
                      )
```

```{r, warning=FALSE, message=FALSE, paged.print=FALSE}
# 3色グラデーション
ggplot(data = data_color,
       mapping = aes(x = x, y = y, fill = y)
       ) +
  geom_col() +
  # 色
  scale_fill_gradient2(low = "Red", # 最小値の色
                       mid = "Gold", # 中間値の色
                       high = "Forestgreen", # 最大値の色
                       midpoint = median(data_color$y) # 中間値
                       )
```

```{r, warning=FALSE, message=FALSE, paged.print=FALSE}
# パレットを指定したn色グラデーション
ggplot(data = data_color,
       mapping = aes(x = x, y = y, fill = y)
       ) +
  geom_col() +
  # 色
  scale_fill_gradientn(colors = brewer.pal(name = "RdYlGn",
                                           n = 9)
                       )
```

## 設定：軸

X軸、Y軸の設定を行うには、グラフの表示範囲を設定する`coord_cartesian()`関数や、目盛・ラベルを設定する `scale_x_*()`・`scale_y_*()`関数ファミリーを使用します。X軸、Y軸に指定する変数の型によって、使用する関数が一部異なります。

なお、`scale_x_*()`・`scale_y_*()`関数ファミリーにも範囲指定を行う`limits`引数がありますが、`coord_cartesian()`関数による範囲指定とは動作が異なる点に注意してください。`coord_cartesian()`関数は単に表示範囲を変えるだけですが、`scale_x_*()`・`scale_y_*()`関数ファミリーの`limits`引数は範囲外のデータを全て除去します。したがって、`ggplot()`関数内で表示内容を計算するグラフ（例えば散布図の近似曲線や、箱ひげ図の箱・ひげ・中央値など）では、`coord_cartesian()`関数と`scale_x_*()`・`scale_y_*()`関数ファミリーの`limits`引数で異なるグラフになる可能性があります。無用なトラブルを避けるため、表示範囲の設定には`coord_cartesian()`関数を使用することを推奨します。

まず、プロット用のデータを作成します。

```{r, paged.print=FALSE}
data_owid_scale <- data_owid %>% 
  dplyr::group_by(location) %>% 
  dplyr::summarise(across(c(new_cases, new_deaths), mean, na.rm = TRUE))

summary(data_owid_scale)
```

### X軸：連続型、Y軸：連続型

連続型変数の目盛・ラベル設定には`scale_*_continuous()`関数を使用します。

```{r, paged.print=FALSE}
ggplot(data = data_owid_scale,
       mapping = aes(x = new_cases, y = new_deaths)
       ) +
  geom_point() +
  geom_smooth() +
  # 軸
  coord_cartesian(xlim = NULL, # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  ylim = NULL, # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  expand = TRUE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_x_continuous(breaks = breaks_x <- seq(0, 1e+06, 100000), # 目盛
                     labels = breaks_x, # 目盛ラベル
                     ) +
  scale_y_continuous(breaks = breaks_y <- seq(0, 10000, 1000), # 目盛
                     labels = breaks_y, # 目盛ラベル
                     ) +
  labs(x = "新規感染者数（1日当たり平均、人）", # X軸のタイトル
       y = "新規死亡者数（1日当たり平均、人）" # Y軸のタイトル
       ) +
  theme(axis.title = element_text(size = 8), # 軸タイトルの文字サイズ
        axis.text.x = element_text(angle = 0, # X軸ラベルの角度
                                   hjust = 0.5, # X軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # X軸ラベルの縦整列位置（0-1）
                                   ), 
        axis.text.y = element_text(angle = 0, # Y軸ラベルの角度
                                   hjust = 0.5, # Y軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # Y軸ラベルの縦整列位置（0-1）
                                   ),
        plot.margin = margin(t = 1, # 図表の上マージン
                             b = 1, # 図表の下マージン
                             r = 6, # 図表の右マージン
                             l = 1, # 図表の左マージン
                             unit = "mm" # 図表マージンの単位
                             )
        )
```

### 対数目盛

連続型変数を対数目盛表示にする場合、目盛・ラベル設定には`scale_*_log10()`関数を使用します。

```{r, paged.print=FALSE}
ggplot(data = data_owid_scale,
       mapping = aes(x = new_cases, y = new_deaths)
       ) +
  geom_point() +
  geom_smooth() +
  # 軸
  coord_cartesian(xlim = NULL, # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  ylim = NULL, # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  expand = TRUE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_x_log10(breaks = breaks_x <- 10 ** seq(-2, 6, 1), # 目盛
                labels = c(breaks_x[1:6], "1万", "10万", "100万"), # 目盛ラベル
                ) +
  scale_y_log10(breaks = breaks_y <- 10 ** seq(-2, 4, 1), # 目盛
                labels = c(breaks_y[1:6], "1万"), # 目盛ラベル
                ) +
  labs(x = "新規感染者数（1日当たり平均、人）", # X軸のタイトル
       y = "新規死亡者数（1日当たり平均、人）" # Y軸のタイトル
       ) +
  theme(axis.title = element_text(size = 8), # 軸タイトルの文字サイズ
        axis.text.x = element_text(angle = 0, # X軸ラベルの角度
                                   hjust = 0.5, # X軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # X軸ラベルの縦整列位置（0-1）
                                   ),
        axis.text.y = element_text(angle = 0, # Y軸ラベルの角度
                                   hjust = 0.5, # Y軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # Y軸ラベルの縦整列位置（0-1）
                                   )
        )
```

### X軸：日付型、Y軸：連続型

日付型変数の目盛・ラベル設定には`scale_*_date()`関数を使用します。ここでは、サンプルデータセット`economics`を使用します。

```{r, paged.print=FALSE}
ggplot(data = economics,
       mapping = aes(x = date, y = unemploy)
       ) + 
  geom_line() +
  # 軸
  coord_cartesian(xlim = as.Date(c("2000-01-01", "2002-12-31")), # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  ylim = c(5000, 9000), # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  expand = TRUE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_x_date(breaks = breaks_x <- seq(as.Date("1900-01-01"), as.Date("2099-12-31"), by = "6 months"), # 日付目盛ベクトル
               date_labels = str_c(str_sub(lubridate::year(breaks_x), 1, 4), "/", lubridate::month(breaks_x)), # 日付目盛ベクトルをラベル用に加工
               ) +
  scale_y_continuous(breaks = breaks_y <- seq(0, 50000, 1000), # 目盛
                     labels = breaks_y, # 目盛ラベル
                     ) +
  labs(x = "日付（年/月）", # X軸のタイトル
       y = "失業者数（千人）" # Y軸のタイトル
       ) +
  theme(axis.title = element_text(size = 8), # 軸タイトルの文字サイズ
        axis.text.x = element_text(angle = 0, # X軸ラベルの角度
                                   hjust = 0.5, # X軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # X軸ラベルの縦整列位置（0-1）
                                   ),
        axis.text.y = element_text(angle = 0, # Y軸ラベルの角度
                                   hjust = 0.5, # Y軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # Y軸ラベルの縦整列位置（0-1）
                                   )
        )
```

`scale_*_date()`関数では、一般的な目盛を指定する`breaks`引数の代わりに、日付型目盛を指定する`date_breaks`引数を利用することができます。その場合は、グラフの表示範囲を指定する`coord_cartesian()`関数の`expand`引数に`FALSE`を指定し、日付軸の目盛が端から表示されるようにします。

```{r, paged.print=FALSE}
# date_breaks引数を使用する場合
ggplot(data = economics,
       mapping = aes(x = date, y = unemploy)
       ) + 
  geom_line() +
  # 軸
  coord_cartesian(xlim = c(as.Date("2000-01-01"), as.Date("2002-12-31")), # 下限・上限値（指定しない場合はNULL）
                  ylim = c(5000, 9000), # 下限・上限値（指定しない場合はNULL）
                  expand = FALSE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_x_date(date_breaks = "6 month",　# 日付目盛の周期
               date_labels = "%Y/%m", # %Y：4桁年、%y：2桁年、%m：2桁月、%d：日
               ) +
  scale_y_continuous(breaks = breaks_y <- seq(0, 50000, 1000), # 目盛
                     labels = breaks_y, # 目盛ラベル
                     ) +
  labs(x = "日付（年/月）", # X軸のタイトル
       y = "失業者数（千人）" # Y軸のタイトル
       ) +
  theme(axis.title = element_text(size = 8), # 軸タイトルの文字サイズ
        axis.text.x = element_text(angle = 0, # X軸ラベルの角度
                                   hjust = 0.5, # X軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # X軸ラベルの縦整列位置（0-1）
                                   ),
        axis.text.y = element_text(angle = 0, # Y軸ラベルの角度
                                   hjust = 0.5, # Y軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # Y軸ラベルの縦整列位置（0-1）
                                   )
        )
```

## 設定：パネル目盛線

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy, fill = class)
       ) +
  geom_point(shape = 21,
             size = 2.0
             ) +
  # パネル目盛線
  theme(panel.grid.major = element_line(color = "grey", # 主目盛線の色
                                        linetype = "dashed", # 主目盛線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
                                        size = 0.2 # 主目盛線の太さ
                                        ),
        panel.grid.minor = element_blank() # 補助目盛り線は表示しない
        )
```

## 設定：凡例

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy, fill = class)
       ) +
  geom_point(shape = 21,
             size = 2.0
             ) +
  # 凡例
  theme(legend.title = element_text(size = 8, # 凡例タイトルの文字サイズ
                                    face = "bold", # 凡例タイトルの書体
                                    hjust = 0.0 # 凡例タイトルの横整列位置
                                    ),
        legend.text = element_text(size = 8), # 凡例ラベルの文字サイズ
        legend.box.background = element_rect(color = "grey", # 凡例の枠線の色
                                             size = 0.5 # 凡例の枠線の太さ
                                             ),
        legend.margin = margin(t = 1, # 凡例の上マージン
                               b = 1, # 凡例の下マージン
                               r = 1, # 凡例の右マージン
                               l = 1, # 凡例の左マージン
                               unit = "mm" # 凡例マージンの単位
                               ),
        legend.justification = c(1.0, 0.0), # 凡例の横整列位置・縦整列位置
        legend.position = c(0.95, 0.05) # 凡例の横位置・縦位置
        ) +
  labs(fill = "車体クラス", # 凡例に使用するscaleのタイトル（表示しない場合はNULL）
       ) +
  guides(fill = guide_legend(keywidth = unit(5, units = "mm"), # 凡例キーの幅
                             keyheight = unit(5, units = "mm"), # 凡例キーの高さ
                             direction = "vertical", # 凡例の整列方向（horizontal / vertical）
                             nrow = 3, # 凡例の行数
                             ncol = 3, # 凡例の列数
                             reverse = FALSE # 凡例順序の逆転
                             )
         )
```

## 設定：タイトル・キャプション

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy, fill = class)
       ) +
  geom_point(shape = 21,
             size = 2.0
             ) +
  # タイトル・キャプション
  labs(title = "車体クラス別の一般道燃費と高速道燃費", # 図表タイトル
       caption = "（出所）EPA.gov", # キャプション
       ) +
  theme(plot.title = element_text(size = 10, # 図表タイトルの文字サイズ
                                  face = "bold", # 図表タイトルの書体
                                  hjust = 0.5 # 図表タイトルの横整列位置
                                  ),
        plot.caption = element_text(size = 8, # キャプションの文字サイズ
                                    face = "plain", # キャプションの書体
                                    hjust = 0.0 # キャプションの横整列位置
                                    )
        )
```

## 設定：フォント・マージン

```{r, paged.print=FALSE}
ggplot(data = mpg,
       mapping = aes(x = cty, y = hwy, fill = class)
       ) +
  # フォント・マージン
  geom_point(shape = 21,
             size = 2.0
             ) +
  theme(text = element_text(size = 8 # 図表全体の無事サイズ
                            ),
        plot.margin = margin(t = 1, # 図表の上マージン
                             b = 1, # 図表の下マージン
                             r = 1, # 図表の右マージン
                             l = 1, # 図表の左マージン
                             unit = "mm" # 図表マージンの単位
                             )
        )
```

## グラフの保存

`ggplot2`パッケージで作成した図表を画像形式で保存するには、`ggsave()`関数を使用します。

```{r, eval=FALSE, paged.print=FALSE}
ggsave(filename = "directory/filename.png", # 図表のファイル名
       width = 12.00, # 図表の横サイズ
       height = 8.50, # 図表の縦サイズ
       units = "cm", # 図表のサイズ単位
       dpi = 400 # 図表の解像度
       )
```

## 実例

### 実例1：折れ線グラフ

日本と欧州主要国の新型コロナ新規感染者数の時系列折れ線グラフを作成します。

まず、外部データセット`data_owid`を用い、プロット用のデータを作成します。外部データセットの取得方法については、第2章「Rの設定」を参照してください。

```{r, paged.print=FALSE}
# 列を選択
data_plot <- data_owid %>%
  dplyr::select(location, date, new_cases_smoothed) 

# 日本と欧州主要国をフィルタ
data_plot %<>% 
  dplyr::filter(location %in% c("Japan", "United Kingdom", "Germany", "France", "Italy"),
                date >= "2022-01-01"
                ) 

# NAを削除
data_plot %<>% 
  tidyr::drop_na(everything())
```

`ggplot()`関数でプロットを作成します。グラフを画像として保存するには、別途`ggsave()`関数を実行してください。

```{r, paged.print=FALSE}
ggplot(data = data_plot,
       mapping = aes(x = date, y = new_cases_smoothed / 1000, color = location)
       ) +
  # グラフ
  geom_line(alpha = 1.0, # 線の透明度
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 0.5 # 線の太さ
            ) +
  # 色
  scale_color_npg() + 
  # 軸
  coord_cartesian(xlim = c(as.Date("2022-01-01"), as.Date("2022-12-31")), # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  ylim = c(0, max(data_plot$new_cases_smoothed / 1000) * 1.05), # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  expand = FALSE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_x_date(breaks = breaks_x <- seq(as.Date("1900-01-01"), as.Date("2099-12-31"), by = "3 months"), # 日付目盛ベクトル
               date_labels = str_c(str_sub(lubridate::year(breaks_x), 1, 4), "/", lubridate::month(breaks_x)), # 日付目盛ベクトルをラベル用に加工
               ) +
  scale_y_continuous(breaks = breaks_y <- seq(0, 1000, 50), # 目盛
                     labels = breaks_y, # 目盛ラベル
                     ) +
  labs(x = "日付（年/月）", # X軸のタイトル
       y = "新規感染者数（千人/日）" # Y軸のタイトル
       ) +
  theme(axis.title = element_text(size = 8), # 軸タイトルの文字サイズ
        axis.text.x = element_text(angle = 0, # X軸ラベルの角度
                                   hjust = 0.5, # X軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # X軸ラベルの縦整列位置（0-1）
                                   ),
        axis.text.y = element_text(angle = 0, # Y軸ラベルの角度
                                   hjust = 0.5, # Y軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # Y軸ラベルの縦整列位置（0-1）
                                   )
        ) +
  # パネル目盛線
  theme(panel.grid.major = element_line(color = "grey", # 主目盛線の色
                                        linetype = "dashed", # 主目盛線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
                                        size = 0.2 # 主目盛線の太さ
                                        ),
        panel.grid.minor = element_blank() # 補助目盛り線は表示しない
        ) +
  # 凡例
  theme(legend.title = element_text(size = 8, # 凡例タイトルの文字サイズ
                                    face = "bold", # 凡例タイトルの書体
                                    hjust = 0.0 # 凡例タイトルの横整列位置
                                    ),
        legend.text = element_text(size = 8 # 凡例ラベルの文字サイズ
                                   ),
        legend.box.background = element_rect(color = "grey", # 凡例の枠線の色
                                             size = 0.5 # 凡例の枠線の太さ
                                             ),
        legend.margin = margin(t = 1, # 凡例の上マージン
                               b = 1, # 凡例の下マージン
                               r = 1, # 凡例の右マージン
                               l = 1, # 凡例の左マージン
                               unit = "mm" # 凡例マージンの単位
                               ),
        legend.justification = c(1.0, 1.0), # 凡例の横整列位置・縦整列位置
        legend.position = c(0.97, 0.95) # 凡例の横位置・縦位置
        ) +
  guides(color = guide_legend(keywidth = unit(5, units = "mm"), # 凡例キーの幅
                              keyheight = unit(5, units = "mm"), # 凡例キーの高さ
                              direction = "vertical", # 凡例の整列方向（horizontal / vertical）
                              nrow = 5, # 凡例の行数
                              ncol = 1, # 凡例の列数
                              reverse = FALSE) # 凡例順序の逆転
         ) +
  # タイトル・キャプション
  labs(title = "日本と欧州主要国の新型コロナ新規感染者数", # 図表タイトル
       caption = "（注）後方7日間移動平均。\n（出所）Our World in Data、@naohat23", # キャプション
       color = "国名" # 凡例に使用するscaleのタイトル
       ) +
  theme(plot.title = element_text(size = 10, # 図表タイトルの文字サイズ
                                  face = "bold", # 図表タイトルの書体
                                  hjust = 0.5 # 図表タイトルの横整列位置
                                  ),
        plot.caption = element_text(size = 8, # キャプションの文字サイズ
                                    face = "plain", # キャプションの書体
                                    hjust = 0.0 # キャプションの横整列位置
                                    )
        ) +
  # フォント・マージン
  theme(text = element_text(size = 8 # 図表全体の無事サイズ
                            ),
        plot.margin = margin(t = 1, # 図表の上マージン
                             b = 1, # 図表の下マージン
                             r = 1, # 図表の右マージン
                             l = 1, # 図表の左マージン
                             unit = "mm" # 図表マージンの単位
                             )
        )
```

### 実例2：積上棒グラフ

日本の実質GDP変化率をマーカー付き折れ線グラフに、内訳の需要項目別寄与度を積上棒グラフにした、時系列グラフを作成します。

まず、外部データセット`data_gdp_jp`を用い、プロット用のデータを作成します。外部データセットの取得方法については、第2章「Rの設定」を参照してください。

```{r, paged.print=FALSE}
# 列を集約
data_plot <- data_gdp_jp %>% 
  dplyr::mutate(`家計` = `民間最終消費支出` + `民間住宅`,
                `政府` = `政府最終消費支出` + `公的固定資本形成` + `公的在庫変動`
                ) %>% 
  dplyr::select(-`民間最終消費支出`, -`民間住宅`,-`政府最終消費支出`, -`公的固定資本形成`, -`公的在庫変動`)

# 列名を変更
data_plot %<>% 
  dplyr::rename(`GDP` = `国内総生産`,
                `設備投資` = `民間企業設備`,
                `在庫` = `民間在庫変動`
                )

# 実質GDPの前期比変化率に対する各需要項目の寄与度を計算
data_plot %<>% 
  dplyr::mutate(across(`GDP`:`政府`, ~ {100 * (. - dplyr::lag(., 1)) / dplyr::lag(`GDP`, 1)}))

# グラフ表示範囲を選択
data_plot %<>%
  dplyr::filter(`日付` >= "2019-01-01")

# GDP全体と寄与度にデータを分割
data_plot_gdp <- data_plot %>% 
  dplyr::select(`日付`, `GDP`)

data_plot_cont <- data_plot %>% 
  dplyr::select(-`GDP`, -`開差`)

# 寄与度データを縦型に変換し、項目の順序を設定
data_plot_cont %<>% 
  tidyr::pivot_longer(cols = -`日付`, names_to = "需要項目", values_to = "寄与度") %>% 
  dplyr::mutate(`需要項目` = factor(`需要項目`,
                                    level = c("家計", "設備投資", "在庫", "政府", "純輸出")
                                    )
                ) %>% 
  dplyr::arrange(`日付`, `需要項目`)
```

`ggplot()`関数でプロットを作成します。グラフを画像として保存するには、別途`ggsave()`関数を実行してください。

```{r, paged.print=FALSE}
ggplot() + 
  # グラフ
  geom_col(data = data_plot_cont,
           mapping = aes(x = `日付`, y = `寄与度`, fill = `需要項目`, group = rev(`需要項目`)),
           #stat = "identity",
           position = position_stack(), # 積上ポジション
           alpha = 1.0, # 塗りつぶしの透明度
           size = 0.5, # 線の太さ
           width = NULL # 棒の幅 (0-1)
           ) +
  guides(fill = guide_legend(reverse = TRUE)) +
  geom_line(data = data_plot_gdp,
            mapping = aes(x = `日付`, y = `GDP`),
            alpha = 1.0, # 線の透明度
            color = "black", # 線の色
            linetype = "solid", # 線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
            size = 1.0 # 線の太さ
            ) +
  geom_point(data = data_plot_gdp,
             mapping = aes(x = `日付`, y = `GDP`),alpha = 1.0, # 塗りつぶしの透明度
             color = "black", # 線の色
             fill = "white", # 塗りつぶしの色
             shape = 21, # マーカーの種類
             size = 2.0, # マーカーの大きさ
             stroke = 0.5 # 線の太さ
             ) +
  # 補助線
  geom_hline(yintercept = 0, # 水平線の縦軸との交点
             color = "grey", # 水平線の色
             size = 0.5 # 水平線の太さ
             ) +
  # 色
  scale_fill_brewer(palette = "Paired", # カラーパレット名
                    direction = 1 # 色の順序（-1で逆順）
                    ) +
  # 軸
  coord_cartesian(xlim = NULL, # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  ylim = NULL, # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  expand = TRUE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_x_date(breaks = breaks_x <- data_plot_gdp$日付[seq(1, length(data_plot_gdp$日付), 2)], # 日付目盛ベクトル
               date_labels = str_c(str_sub(lubridate::year(breaks_x), 1, 4), "/", lubridate::month(breaks_x)), # 日付目盛ベクトルをラベル用に加工
               ) +
  scale_y_continuous(breaks = breaks_y <- seq(-20, 20, 1), # 目盛
                     labels = breaks_y %>% stringr::str_replace_all("-", "▲"), # 目盛ラベル
                     ) +
  labs(x = "日付（年/月）", # X軸のタイトル
       y = "実質GDP変化率（前期比、％）" # Y軸のタイトル
       ) +
  theme(axis.title = element_text(size = 8), # 軸タイトルの文字サイズ
        axis.text.x = element_text(angle = 0, # X軸ラベルの角度
                                   hjust = 0.5, # X軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # X軸ラベルの縦整列位置（0-1）
                                   ),
        axis.text.y = element_text(angle = 0, # Y軸ラベルの角度
                                   hjust = 1.0, # Y軸ラベルの横整列位置（0-1）
                                   vjust = 0.5 # Y軸ラベルの縦整列位置（0-1）
                                   )
        ) +
  # パネル目盛線
  theme(panel.grid.major = element_line(color = "grey", # 主目盛線の色
                                        linetype = "dashed", # 主目盛線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
                                        size = 0.2 # 主目盛線の太さ
                                        ),
        panel.grid.minor = element_blank() # 補助目盛り線は表示しない
        ) +
  # 凡例
  theme(legend.title = element_text(size = 8, # 凡例タイトルの文字サイズ
                                    face = "bold", # 凡例タイトルの書体
                                    hjust = 0.0 # 凡例タイトルの横整列位置
                                    ),
        legend.text = element_text(size = 8), # 凡例ラベルの文字サイズ
        legend.box.background = element_rect(color = "grey", # 凡例の枠線の色
                                             size = 0.5 # 凡例の枠線の太さ
                                             ),
        legend.margin = margin(t = 1, # 凡例の上マージン
                               b = 1, # 凡例の下マージン
                               r = 1, # 凡例の右マージン
                               l = 1, # 凡例の左マージン
                               unit = "mm" # 凡例マージンの単位
                               ),
        legend.justification = c(0.5, 0.5), # 凡例の横整列位置・縦整列位置
        legend.position = "right" # 凡例の横位置・縦位置
        ) +
  guides(fill = guide_legend(keywidth = unit(5, units = "mm"), # 凡例キーの幅
                             keyheight = unit(5, units = "mm"), # 凡例キーの高さ
                             direction = "vertical", # 凡例の整列方向（horizontal / vertical）
                             nrow = 5, # 凡例の行数
                             ncol = 1, # 凡例の列数
                             reverse = FALSE # 凡例順序の逆転
                             )
         ) +
  # タイトル・キャプション
  labs(title = "日本の実質GDP変化率の項目別寄与度", # 図表タイトル
       caption = "（注）家計は個人消費と住宅の合計。\n（出所）内閣府「四半期別GDP速報」。", # キャプション
       fill = element_blank() # 凡例に使用するscaleのタイトル
       ) +
  theme(plot.title = element_text(size = 10, # 図表タイトルの文字サイズ
                                  face = "bold", # 図表タイトルの書体
                                  hjust = 0.5 # 図表タイトルの横整列位置
                                  ),
        plot.caption = element_text(size = 8, # キャプションの文字サイズ
                                    face = "plain", # キャプションの書体
                                    hjust = 0.0 # キャプションの横整列位置
                                    )
        ) +
  # フォント・マージン
  theme(text = element_text(size = 8 # 図表全体の無事サイズ
                            ),
        plot.margin = margin(t = 1, # 図表の上マージン
                             b = 1, # 図表の下マージン
                             r = 1, # 図表の右マージン
                             l = 1, # 図表の左マージン
                             unit = "mm" # 図表マージンの単位
                             )
        )
  
```

### 実例3：箱ひげ図

世界各国の新型コロナ死亡率の分布を年別に集計した箱ひげ図を作成します。

まず、外部データセット`data_owid`を用い、プロット用のデータを作成します。外部データセットの取得方法については、第2章「Rの設定」を参照してください。

```{r, results='hide', warning=FALSE, message=FALSE, paged.print=FALSE}
# 新規感染者数と新規死亡者数の列を選択
data_plot <- data_owid %>% 
  dplyr::select(location, date, new_cases, new_deaths)

# 年の列を追加し年別の平均を集計
data_plot %<>% 
  dplyr::mutate(year = lubridate::year(date)) %>% 
  dplyr::group_by(location, year) %>% 
  dplyr::summarise(across(c(new_cases, new_deaths), mean, na.rm = TRUE))

# 年別の死亡率を計算
data_plot %<>% 
  dplyr::mutate(mort_rate = 100 * new_deaths / new_cases,
                year = str_c(year, "年")
                )
```

`ggplot()`関数でプロットを作成します。グラフを画像として保存するには、別途`ggsave()`関数を実行してください。

```{r, paged.print=FALSE}
ggplot(data = data_plot,
       mapping = aes(x = year, y = mort_rate, color = year, fill = year)
       ) +
  # グラフ
  geom_boxplot(outlier.shape = NA, alpha = 0.25, size = 0.5) +
  geom_jitter(alpha = 0.5, size = 1.0, shape = 21) +
  # 補助線
  geom_hline(yintercept = 0, # 水平線の縦軸との交点
             color = "gray", # 水平線の色
             size = 0.5 # 水平線の太さ
             ) +
  # 軸
  coord_cartesian(xlim = NULL, # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  ylim = c(0, 5), # 下限・上限値（両方指定しない場合はNULL、片側のみ指定しない場合はNA）
                  expand = TRUE # 表示範囲を下限・上限値から小幅に拡大（拡大しない場合はFALSE)
                  ) +
  scale_y_continuous(breaks = breaks_y <- seq(0, 100, 0.5), # 目盛
                     labels = breaks_y %>% sprintf(fmt = "%0.1f"), # 目盛ラベル
                     ) +
  labs(x = element_blank(), # X軸のタイトル
       y = "新型コロナ感染者の致死率（％）" # Y軸のタイトル
       ) +
  theme(axis.title = element_text(size = 8) # 軸タイトルの文字サイズ
        ) +
  # パネル目盛線
  theme(panel.grid.major = element_line(color = "grey", # 主目盛線の色
                                        linetype = "dashed", # 主目盛線の種類（solid / dashed / dotted / dotdash / twodash / longdash）
                                        size = 0.2 # 主目盛線の太さ
                                        ),
        panel.grid.minor = element_blank() # 補助目盛り線は表示しない
        ) +
  # 凡例
  theme(legend.position = "none" # 凡例の横位置・縦位置
        ) +
  # タイトル・キャプション
  labs(title = "世界各国の新型コロナ感染者の致死率（年別）", # 図表タイトル
       caption = "（注）箱の中の横線は中央値を示す。\n（出所）Our World in Data、@naohat23" # キャプション
       ) +
  theme(plot.title = element_text(size = 10, # 図表タイトルの文字サイズ
                                  face = "bold", # 図表タイトルの書体
                                  hjust = 0.5 # 図表タイトルの横整列位置
                                  ),
        plot.caption = element_text(size = 8, # キャプションの文字サイズ
                                    face = "plain", # キャプションの書体
                                    hjust = 0.0 # キャプションの横整列位置
                                    )
        ) +
  # フォント・マージン
  theme(text = element_text(size = 8 # 図表全体の無事サイズ
                            ),
        plot.margin = margin(t = 1, # 図表の上マージン
                             b = 1, # 図表の下マージン
                             r = 1, # 図表の右マージン
                             l = 1, # 図表の左マージン
                             unit = "mm" # 図表マージンの単位
                             )
        )
```
