# Rの設定

第1章「Rの設定」では、Rを使用する際の各種設定について解説します。Rのインストール、プロキシサーバーの設定、パッケージのインストール・インポート、グラフの設定など、Rの使用に欠かせない様々な設定について記載しています。

また、本書で使用するサンプルデータセットも、この章で紹介しています。特に、ウェブから読み込む外部データセットについては、この章で取得方法を記載していますので、確認してください。

この章の最後に、Rを起動時に実行すべき設定をまとめています。実際にRを使用する際にご利用ください。

## 設定全般

### Rのインストール {.unnumbered}

Rは[The Comprehensive R Archive Network](https://cran.r-project.org/)からダウンロードしてインストールしてください。2020年にバージョン4へメジャーアップデートが行われており、本書でもバージョン4を使用しています。

Rの統合開発環境であるRStudioは、開発元の[rstudio.com](https://www.rstudio.com/)からインストールできます。上部メニューのDOWNLOADからダウンロードページに進み、RStudio DesktopのFree版をダウンロードしてインストールしてください。

Windows環境でRの一部のパッケージを使用する際、Rtoolsというツールが必要な場合がありますので、[こちらのウェブサイト](https://cran.r-project.org/bin/windows/Rtools/)からRのバージョンに合ったものをダウンロードしてインストールします。

### Rのバージョン確認 {.unnumbered}

Rのバージョン情報を出力します。

```{r, warning=FALSE, message=FALSE}
version
```

### セッション情報の確認 {.unnumbered}

Rのバージョンに加え、使用環境、パッケージ情報を出力します。

```{r}
sessionInfo()
```

### オブジェクトを全削除 {.unnumbered}

変数をすべて削除してワークスペースを初期化します。

```{r}
rm(list = ls())
```

### 警告の非表示 {.unnumbered}

Rが出力する警告（Warning）を非表示にします。

```{r}
options(warn = -1)
```

### 関数が出力する警告やメッセージの非表示 {.unnumbered}

関数が出力する警告やメッセージは`options(warn = -1)`で非表示にできないため、関数毎に、必要に応じて`suppressWarnings()`関数や`suppressMessages()`関数を使用します。

```{r, eval=FALSE}
suppressWarnings(警告を出力する関数)
suppressMessages(メッセージを出力する関数)
```

## プロキシサーバーの設定

オフィスや大学などのプロキシ環境ではプロキシサーバーの設定を行ってください。なお、下記のコードは認証プロキシには非対応です。

```{r, eval=FALSE}
# プロキシサーバーとポートを記入
proxy_url <- "http://proxyserver:port/"


# Rのシステム環境変数を設定
Sys.setenv("http_proxy" = proxy_url)
Sys.setenv("https_proxy" = proxy_url)


# Rのダウンロードオプションを設定
options(download.file.method = "libcurl")
options(timeout = NA)
```

## パッケージ

### 使用するパッケージ一覧 {.unnumbered}

-   tidyverse系
    -   [lubridate](https://lubridate.tidyverse.org/)：日付処理
    -   [magrittr](https://magrittr.tidyverse.org/)：パイプ処理
    -   [tidyverse](https://www.tidyverse.org/)：モダンなデータ分析用パッケージセット
    -   [readxl](https://readxl.tidyverse.org/)：Excelファイルの読み込み
-   図表系
    -   [esquisse](https://cran.r-project.org/web/packages/esquisse/vignettes/get-started.html)：shinyを使用したGUI形式の直感的な図表作成
    -   [geofacet](https://cran.r-project.org/web/packages/geofacet/vignettes/geofacet.html)：地図形式の複合グラフ（ファセット）配置
    -   [ggplotgui](https://cran.r-project.org/web/packages/ggplotgui/README.html)：shinyを使用したGUI形式の直感的な図表作成
    -   [ggpubr](https://rpkgs.datanovia.com/ggpubr/)：論文形式の図表作成
    -   [ggsci](https://cran.r-project.org/web/packages/ggsci/vignettes/ggsci.html)：科学系論文の雑誌別カラーパレット
    -   [ggrepel](https://ggrepel.slowkow.com/index.html)：散布図のラベル付与
    -   hexbin：`geom_hex()`関数を使用するために必要なパッケージ
    -   [lemon](https://github.com/stefanedwards/lemon)：複合グラフ（ファセット）の軸・目盛り表示
    -   [RColorBrewer](https://cran.r-project.org/web/packages/RColorBrewer/index.html)：カラーパレット
-   統計系
    -   [corrplot](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html)：相関係数行列の計算・可視化
    -   [corrr](https://corrr.tidymodels.org/)：相関係数行列の計算・可視化
    -   [DataExplorer](https://cran.r-project.org/web/packages/DataExplorer/vignettes/dataexplorer-intro.html)：探索的データ分析の一括実行
    -   [estimatr](https://declaredesign.org/r/estimatr/)：線形回帰モデルの推定
    -   [fpp2](https://otexts.com/fpp2/)：時系列データ予測の教科書用に開発されたパッケージ
    -   [GGally](https://ggobi.github.io/ggally/index.html)：ペアプロットなどのデータ可視化
    -   [mFilter](https://www.rdocumentation.org/packages/mFilter/versions/0.1-5/topics/hpfilter)：HPフィルタ
    -   [mgcv](https://cran.r-project.org/web/packages/mgcv/mgcv.pdf)：一般化加法モデル（GAM）
    -   plm：パネルデータモデル
    -   [psych](https://personality-project.org/r/psych/)：心理統計パッケージ
    -   [seasonal](https://cran.r-project.org/web/packages/seasonal/readme/README.html)：コマンド形式の季節調整
    -   [seasonalview](https://cran.r-project.org/web/packages/seasonalview/README.html)：GUI形式の季節調整
    -   sigmoid：シグモイド関数
    -   [SmartEDA](https://daya6489.github.io/SmartEDA/)：探索的データ分析の一括実行
    -   [tidyquant](https://business-science.github.io/tidyquant/index.html)：金融時系列データ分析
-   その他
    -   [openxlsx](https://ycphs.github.io/openxlsx/)：Excelのxlsxファイルの読み込み・編集・書き出し
    -   [pblapply](https://www.rdocumentation.org/packages/pbapply/versions/1.4-3/topics/pbapply)：プログレスバーを表示する`apply()`関数ファミリー

### パッケージのインストールとインポート {.unnumbered}

パッケージのインストールは`install.packages()`関数、インストールしたパッケージのインポート（呼び出し）は`library()`関数で実行します。一度インストールすれば、その後はインポートするだけでパッケージを使用することができます。

```{r, results='hide', warning=FALSE, message=FALSE}
# パッケージ一覧
packages <- c(
  "lubridate", "magrittr", "tidyverse", "readxl",
  "esquisse", "geofacet", "ggplotgui", "ggpubr", "ggsci", "ggrepel", "hexbin", "lemon", "RColorBrewer",
  "corrplot", "corrr", "DataExplorer", "estimatr", "fpp2", "GGally", "mfilter", "mgcv", "plm", "psych", "seasonal", "seasonalview", "sigmoid", "SmartEDA", "tidyquant",
  "openxlsx", "pbapply"
)

# インストールしていないパッケージがあればインストール
new_packages <- packages[!(packages %in% installed.packages()[,"Package"])]

if(length(new_packages)) {
  install.packages(new_packages)
}

# パッケージをインポート
for (pkg in packages) {
  library(pkg, character.only = TRUE)
}

# 変数を削除
rm(
  new_packages,
  packages,
  pkg
)
```

Rのパッケージは開発者が随時アップデートしていますが、自動で反映されることはありません。パッケージをアップデートする場合は、次のコードを実行してください。

```{r, eval=FALSE}
# パッケージをすべてアップデート
update.packages()

# アップデートの対象になる古いバージョンのパッケージ一覧を出力
old.packages()

# パッケージを指定してアップデート
install.packages("tidyverse")
```

## グラフの設定

レポートやスライドに掲載するためのグラフは、主にRの`ggplot2`パッケージで作成します。

### グラフのテーマ設定 {.unnumbered}

実務上、Excelと併用することを想定しているため、Excelで出力されるグラフに似たテーマである`theme_light()`を設定します。`ggplot2`パッケージにデフォルトで用意されている様々なテーマについては、[公式ウェブサイト](https://ggplot2.tidyverse.org/reference/ggtheme.html)を参照してください。

```{r}
theme_set(theme_light())
```

### グラフのフォント設定 {.unnumbered}

Windows上でRを使用する場合は、日本語フォントをグラフ上で表示するために以下の設定が必要です。ここでは代表的なフォントとしてMeiryo UIとYu Gothic UIを設定します。それぞれのフォントに`MEIRYO`、`YUGO`というキーを割り当て、`ggplot2`パッケージでグラフを作成する際にキーを指定します。

```{r}
windowsFonts("MEIRYO" = windowsFont("Meiryo UI"))
windowsFonts("YUGO" = windowsFont("Yu Gothic UI"))
```

## サンプルデータセット

本書で使用するサンプルデータセットの一覧です。Rの本体もしくはパッケージから呼び出せるデータセットと、ウェブから取得する外部データセットがあります。

### Rのサンプルデータセット {.unnumbered}

#### unemp {.unnumbered}

`Seasonal`パッケージに含まれる`unemp`データセットです。1990年1月から2016年11月までの米国の失業者数（単位：千人）の月次データ（原数値）であり、データ形式はts型です。

[データ出所リンク](https://fred.stlouisfed.org/series/LNU03000000)

```{r}
seasonal::unemp
```

#### gasoline {.unnumbered}

`fpp2`パッケージに含まれる`gasoline`データセットです。1991年2月2日から2017年１月20日までの米国ガソリン生産量（単位：百万バレル／日）の週次データであり、データ形式はts型です。

#### iris {.unnumbered}

```{r}
iris_tbl <- as.tibble(iris)
iris_tbl
```

#### mpg {.unnumbered}

```{r}
mpg
```

#### diamonds {.unnumbered}

```{r}
diamonds
```

#### economics {.unnumbered}

```{r}
economics
```

#### mtcars {.unnumbered}

```{r}
mtcars
```

### 外部データセット

外部データセットはウェブから読み込むため、プロキシ環境ではプロキシサーバーの設定が必要です。

```{r, eval=FALSE}
# プロキシサーバーとポートを記入
proxy_url <- "http://proxyserver:port/"


# Rのシステム環境変数を設定
Sys.setenv("http_proxy" = proxy_url)
Sys.setenv("https_proxy" = proxy_url)


# Rのダウンロードオプションを設定
options(download.file.method = "libcurl")
options(timeout = NA)
```

#### OWIDのCOVID-19データセット {.unnumbered}

Our World in Dataの新型コロナウイルス関連データセットです。データの詳細は[Our World in Dataのウェブサイト](https://ourworldindata.org/coronavirus)を参照してください。

Hannah Ritchie, Edouard Mathieu, Lucas Rodés-Guirao, Cameron Appel, Charlie Giattino, Esteban Ortiz-Ospina, Joe Hasell, Bobbie Macdonald, Diana Beltekian and Max Roser (2020) - "Coronavirus Pandemic (COVID-19)". Published online at OurWorldInData.org. Retrieved from: '<https://ourworldindata.org/coronavirus>' [Online Resource]

```{r, warning=FALSE, message=FALSE}
# Our World in Dataの新型コロナデータをtibble型で読み込み
data_owid <- readr::read_csv(file = "https://covid.ourworldindata.org/data/owid-covid-data.csv", # ファイルパス／URL
                             col_names = TRUE, # ヘッダー（列名データ）の有無
                             col_types = NULL, # 各列の型の指定（c：文字列型、d：数値型、D：日付型、l：論理値型）
                             skip = 0) # 読み込み時に上からスキップする行数

# 使用するデータを絞り込み
data_owid %<>% 
  dplyr::select(continent, location, date, 
                total_cases, new_cases, total_deaths, new_deaths, 
                total_cases_per_million, new_cases_per_million, total_deaths_per_million, new_deaths_per_million,
                people_fully_vaccinated) %>% 
  dplyr::filter(location %in% c("Japan", "United States", "United Kingdom", "Germany"))

# データをコンソールに出力
data_owid
```

#### 日本の産業別就業者数 {.unnumbered}

総務省が公表する労働力調査の長期時系列データのうち、2002年1月以降の産業別就業者数（表番号：1-c-3）を格納したデータセットです。詳細は[e-Statの該当ページ](https://www.e-stat.go.jp/stat-search/files?page=1&toukei=00200531&tstat=000000110001)を参照してください。

```{r}
# 総務省の労働力調査データをdata.frame形式で読み込み
data_labor <- openxlsx::read.xlsx(xlsxFile = "https://www.e-stat.go.jp/stat-search/file-download?statInfId=000031831374&fileKind=0", # ファイルパス／URL
                                  sheet = 1, # シートインデックス／シート名
                                  startRow = 10, # 読み込み開始行
                                  colNames = FALSE, # 列名データの有無
                                  rowNames = FALSE, # 行名データの有無
                                  rows = NULL, # 読み込む列（NULLですべて読み込み）
                                  cols = NULL) # 読み込む行（NULLですべて読み込み）

# 不要な列を削除
data_labor %<>%
  dplyr::select(-X1, -X2, -X3, -X6)

# 列名を追加
colnames(data_labor) <- c("総数", 
                          "農林", 
                          "建設", 
                          "製造", 
                          "情報通信", 
                          "運輸・郵便", 
                          "卸・小売", 
                          "金融・保険", 
                          "不動産・物品賃貸",
                          "学術・専門・技術",
                          "宿泊・飲食",
                          "生活関連・娯楽",
                          "教育",
                          "医療・福祉",
                          "複合サービス",
                          "その他サービス",
                          "公務")

# NAを含む行を削除
data_labor %<>% 
  tidyr::drop_na(everything())

# すべての列を数値型に変換
data_labor %<>% 
  dplyr::mutate(across(everything(), as.double))

# 日付列を追加
data_labor %<>% 
  dplyr::mutate(date = seq(from = as.Date("2002-01-01"), to = as.Date("2002-01-01") + months(dim(data_labor)[1] - 1), by = "1 month"),
                .before = "総数")

# tibble形式に変換
data_labor %<>% tibble::as_tibble()

# データをコンソールに出力
data_labor
```

#### 日本の県内総生産 {.unnumbered}

内閣府が公表する県内総生産データセットです（生産側、名目、2008SNA、平成23年基準計数）。詳細は[内閣府のウェブサイト](https://www.esri.cao.go.jp/jp/sna/data/data_list/kenmin/files/contents/main_2018.html)を参照してください。ここではデータをdata.frame形式で読み込み、前処理して縦型のtibble形式に変換します。

```{r}
# 内閣府の県内総生産データをdata.frame形式で読み込み
data_gdp_pref <- openxlsx::read.xlsx(xlsxFile = "https://www.esri.cao.go.jp/jp/sna/data/data_list/kenmin/files/contents/tables/2018/soukatu1.xlsx", # ファイルパス／URL
                                     sheet = 1, # シートインデックス／シート名
                                     startRow = 5, # 読み込み開始行
                                     colNames = TRUE, # 列名データの有無
                                     rowNames = FALSE, # 行名データの有無
                                     rows = 5:53, # 読み込む列（NULLですべて読み込み）
                                     cols = NULL) # 読み込む行（NULLですべて読み込み）

# データの型変換等を行い、縦型に変形したうえで、変化率系列を作成し、tibble形式に変換
data_gdp_pref %<>% 
  dplyr::mutate(across(`2006`:`2018`, as.double)) %>% 
  dplyr::rename(pref_code = X1,
                pref_name = X2) %>% 
  dplyr::select(-X16) %>% 
  tidyr::pivot_longer(cols = c(-"pref_code", -"pref_name"), names_to = "year", values_to = "gdp_nominal") %>% 
  dplyr::mutate(across(c(pref_code, year), as.double)) %>% 
  dplyr::arrange(pref_code, year) %>% 
  dplyr::group_by(pref_name) %>% 
  dplyr::mutate(gdp_nominal_pchg = 100 * (gdp_nominal / dplyr::lag(gdp_nominal, n = 1) - 1)) %>% 
  dplyr::ungroup() %>% 
  tibble::as_tibble()

data_gdp_pref
```

#### 西山 他（2019） {.unnumbered}

本書の第7章以降の計量経済学パートでは、西山 他（2019）の実証例で使用されているサンプルデータセットを使用します。サンプルデータセットは、[西山 他（2019）のサポートウェブサイト](http://www.yuhikaku.co.jp/books/detail/9784641053854)で配布されています。

## R起動時に実行する設定

ここまでに紹介した各種設定のうち、Rを起動したときに毎回実行する必要があるものをひとまとめにしました。

```{r, eval=FALSE}
# 全変数を削除
rm(list = ls())


# 警告の非表示
options(warn = -1)


# プロキシ設定（使用環境に応じproxyserverとportを記入）
proxy_url <- "http://proxyserver:port/"

Sys.setenv("http_proxy" = proxy_url)
Sys.setenv("https_proxy" = proxy_url)

options(download.file.method = "libcurl")
options(timeout = NA)


# パッケージのインストールとインポート
packages <- c(
  "lubridate", "magrittr", "tidyverse", "readxl",
  "esquisse", "geofacet", "ggplotgui", "ggpubr", "ggsci", "ggrepel", "hexbin", "lemon", "RColorBrewer",
  "corrplot", "corrr", "DataExplorer", "estimatr", "fpp2", "GGally", "mfilter", "mgcv", "plm", "psych", "seasonal", "seasonalview", "sigmoid", "SmartEDA", "tidyquant",
  "openxlsx", "pbapply"
)

new_packages <- packages[!(packages %in% installed.packages()[,"Package"])]

if(length(new_packages)) {
  install.packages(new_packages)
}

for (pkg in packages) {
  library(pkg, character.only = TRUE)
}

rm(
  new_packages,
  packages,
  pkg
)


# グラフ設定
theme_set(theme_light())

windowsFonts("MEIRYO" = windowsFont("Meiryo UI"))
windowsFonts("YUGO" = windowsFont("Yu Gothic UI"))
```
